[toc]

# Linux网络管理

## 1. RHEL8网络管理架构

- ==网络管理是在操作系统 = 软件层面进行的，掌握如何使用应用/软件告诉Kernel对对应的网卡（通过驱动）进行配置==

- `Kernel`通过==总线==识别到==网卡==（接在主板上）

  - 单凭==总线==是无法判断是哪个设备的，所以`Kernel`通过标识这些设备以便于软件/用户识别

  ```bash
  # 网络总线信息
  [root@RHEL8-RHCE network-scripts]$ lshw -class net -businfo
  Bus info          Device      Class       Description
  =====================================================
  pci@0000:00:03.0  enp0s3      network     82540EM Gigabit Ethernet Controller
  pci@0000:00:08.0  enp0s8      network     82540EM Gigabit Ethernet Controller
  
  # list all PCI devices - 查看主板上的总线
  [root@RHEL8-RHCE network-scripts]$ lspci
  00:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC [Natoma] (rev 02)
  00:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA [Natoma/Triton II]
  00:01.1 IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)
  00:02.0 VGA compatible controller: VMware SVGA II Adapter
  00:03.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 02)
  00:04.0 System peripheral: InnoTek Systemberatung GmbH VirtualBox Guest Service
  00:05.0 Multimedia audio controller: Intel Corporation 82801AA AC'97 Audio Controller (rev 01)
  00:06.0 USB controller: Apple Inc. KeyLargo/Intrepid USB
  00:07.0 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI (rev 08)
  00:08.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 02)
  00:0b.0 USB controller: Intel Corporation 82801FB/FBM/FR/FW/FRW (ICH6 Family) USB2 EHCI Controller
  00:0d.0 SATA controller: Intel Corporation 82801HM/HEM (ICH8M/ICH8M-E) SATA Controller [AHCI mode] (rev 02)
  ```

## 2. NetworkManager

- ==Recommendation== - Since RHEL7，设计目的：统一网络配置，所有网络相关配置都通过`NetworkManager`实现

  ```bash
  # make sure service is up
  [root@RHEL8-RHCE network-scripts]$ systemctl status NetworkManager
  ● NetworkManager.service - Network Manager
     Loaded: loaded (/usr/lib/systemd/system/NetworkManager.service; enabled; vendor preset: enabled)
     Active: active (running) since Fri 2023-01-20 16:12:07 CST; 22min ago
       Docs: man:NetworkManager(8)
   Main PID: 1192 (NetworkManager)
      Tasks: 3 (limit: 11224)
     Memory: 9.2M
     CGroup: /system.slice/NetworkManager.service
             └─1192 /usr/sbin/NetworkManager --no-daemon
  ```

- 早期配置网络（无SDN）

  1. 创建网卡配置文件

  2. 添加/修改网络参数

  3. 重启网络服务，使服务加载到配置文件到内存，让内核读取配置进行网卡配置

     ```bash
     # /etc/sysconfig/network-scripts
     [tutorj@RHEL8-RHCE network-scripts]$ cat /etc/sysconfig/network-scripts/ifcfg-enp0s3
     TYPE=Ethernet
     PROXY_METHOD=none
     BROWSER_ONLY=no
     BOOTPROTO=dhcp
     DEFROUTE=yes
     IPV4_FAILURE_FATAL=no
     IPV6INIT=yes
     IPV6_AUTOCONF=yes
     IPV6_DEFROUTE=yes
     IPV6_FAILURE_FATAL=no
     NAME=enp0s3
     UUID=8e17842e-3d41-4cc0-b635-cd2b85fc5787
     DEVICE=enp0s3
     ONBOOT=yes
     DNS1=8.8.8.8
     ```

- Add NIC in VMware (TODO)

  ```bash
  # check network businfo
  lshw -class net -businfo
  ```

- Tools - no vim anymore:smile: 

  - `nm-connection-editor` -  GUI for NetworkManager

    - 如果是console操作，操作系统必须安装图形化界面

    - 如果是remote操作，即使操作系统没有安装图形界面，远程的终端如果安装了图形服务器软件，也可以使用 - `Xming` / `XManager`

      

    ![image-20230120165921575](D:\rhce8\section1\img\image-20230120165921575.png)

    

  - `nmtui` - Terminal UI for NetworkManager - 伪图形界面 - 通过终端字符模拟图形化界面

    

    <img src="D:\rhce8\section1\img\image-20230120170733166.png" alt="image-20230120170733166" style="zoom:80%;" />

## 3. nmcli

- `nmcli` - command-line tool for controlling NetworkManager

  - ==理念：将网卡和配置文件进行分离==

  ```bash
  # 查看网卡和网卡配置的概述 - hardware level (read via Kernel)
  
  # DEVICE     - 网卡名称 - Kernel label
  # TYPE       - 网卡类型 - Kernel label
  
  # STATE      - 网卡状态（NetworManager是否接管了该网卡）
  # 	unmanaged    - 网卡并未被NetworkManager所接管，无法进行配置
  #   disconnected - 网卡并没有任何配置文件
  #   connected    - 网卡正在使用配置文件
  #   connecting   - 网卡正在获取IP地址（有可能获取不到）
  
  # CONNECTION - 当前网卡使用的配置文件
  [root@RHEL8-RHCE network-scripts]$ nmcli device status
  DEVICE  TYPE      STATE                   CONNECTION
  enp0s3  ethernet  connected               enp0s3
  enp0s8  ethernet  connected               enp0s8
  virbr0  bridge    connected (externally)  virbr0
  lo      loopback  unmanaged               --
  
  # device action
  [root@RHEL8-RHCE network-scripts]$ nmcli device
  checkpoint  delete      down        lldp        monitor     set         status      wifi
  connect     disconnect  help        modify      reapply     show        up
  
  
  # delete device
  # 只能删除虚拟网卡，不能删除物理网卡（废话！）
  [root@RHEL8-RHCE network-scripts]$ nmcli device delete lo
  Device 'lo' successfully removed.
  [root@RHEL8-RHCE network-scripts]$ nmcli device status
  DEVICE  TYPE      STATE                   CONNECTION
  enp0s3  ethernet  connected               enp0s3
  enp0s8  ethernet  connected               enp0s8
  virbr0  bridge    connected (externally)  virbr0
  
  # disconnect a device (from connection)
  # 切断网卡和配置文件的关联
  [root@RHEL8-RHCE network-scripts]$ nmcli device disconnect enp0s8
  Device 'enp0s8' successfully disconnected.
  [root@RHEL8-RHCE network-scripts]$ nmcli device status
  DEVICE  TYPE      STATE                   CONNECTION
  enp0s3  ethernet  connected               enp0s3
  virbr0  bridge    connected (externally)  virbr0
  enp0s8  ethernet  disconnected            --
  
  # connect a device (with connection)
  # 建立网卡和配置文件的关联
  [root@RHEL8-RHCE network-scripts]$ nmcli device connect enp0s8
  Device 'enp0s8' successfully activated with 'ecdbabdf-c2ad-4f59-b506-25107eac57b3'.
  [root@RHEL8-RHCE network-scripts]$ nmcli device status
  DEVICE  TYPE      STATE                   CONNECTION
  enp0s3  ethernet  connected               enp0s3
  enp0s8  ethernet  connected               enp0s8
  virbr0  bridge    connected (externally)  virbr0
  
  
  # show a specific device
  [root@RHEL8-RHCE network-scripts]$ nmcli device show
  enp0s3  enp0s8  help    virbr0
  [root@RHEL8-RHCE network-scripts]$ nmcli device show enp0s3
  # Kernel label
  GENERAL.DEVICE:                         enp0s3
  GENERAL.TYPE:                           ethernet
  GENERAL.HWADDR:                         08:00:27:DA:E6:57
  GENERAL.MTU:                            1500
  GENERAL.STATE:                          100 (connected)
  GENERAL.CONNECTION:                     enp0s3
  GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveConnection/1
  
  WIRED-PROPERTIES.CARRIER:               on
  IP4.ADDRESS[1]:                         10.0.3.4/24
  IP4.GATEWAY:                            10.0.3.1
  IP4.ROUTE[1]:                           dst = 10.0.3.0/24, nh = 0.0.0.0, mt = 100
  IP4.ROUTE[2]:                           dst = 0.0.0.0/0, nh = 10.0.3.1, mt = 100
  IP4.DNS[1]:                             8.8.8.8
  IP4.DNS[2]:                             192.168.1.1
  IP4.DNS[3]:                             192.168.0.1
  IP6.ADDRESS[1]:                         fe80::a00:27ff:feda:e657/64
  IP6.GATEWAY:                            --
  IP6.ROUTE[1]:                           dst = fe80::/64, nh = ::, mt = 1024
  ```

  

  - 服务器网卡

    - 一般4~8块，2块用作管理网络，2块用作traffic，2块用作存储（如果使用本地网卡则不需），2块额外网卡作高速虚拟化网卡抓发（SR-IOV）
    - 最少2块onboard网卡，至少千兆；通过PCI总线连接的外部网卡，至少万兆（光纤）
    - 一般管理管理网卡在装系统时已经配置好，我们一般都是配置traffic和存储网卡
    - 如果误操作将管理网络配置文件配置错误，导致无法远程连接，最坏的情况要去机房进行修复

    

  - 一般配置网卡参数，只有root才能操作

    - IP Addr

    - IP Mask

    - IP Gateway

    - IP DNS

    - IP Method (Manual or DHCP)

    - IP Autoconnect (开机是否自动连接配置文件)

      

  ```bash
  # 对网卡配置文件进行操作
  [root@RHEL8-RHCE tutorj]$ nmcli connection
  add      clone    delete   down     edit     export   help     import   load     migrate  modify   
  monitor  reload   show     up
  
  # i/f config dir
  [root@RHEL8-RHCE tutorj]$ ll /etc/sysconfig/network-scripts/
  total 8
  -rw-r--r--. 1 root root 261 Dec 31 15:10 ifcfg-enp0s3
  -rw-r--r--. 1 root root 346 Jan 20 17:00 ifcfg-eth0
  
  # show connection
  # NAME   - 网卡配置文件名，可重复，但不建议重复
  # UUID   - 唯一标识
  # TYPE   - 网卡配置文件类型，一般ethernet 
  # DEVICE - 网卡配置服务的网卡
  [root@RHEL8-RHCE tutorj]$ nmcli connection show
  NAME    UUID                                  TYPE      DEVICE
  enp0s3  8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  enp0s8  ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  enp0s8
  virbr0  5cdbcd8b-09f8-4f28-affb-900db07e8088  bridge    virbr0、
  
  [root@RHEL8-RHCE tutorj]$ nmcli connection show enp0s3 | head
  connection.id:                          enp0s3
  connection.uuid:                        8e17842e-3d41-4cc0-b635-cd2b85fc5787
  connection.stable-id:                   --
  connection.type:                        802-3-ethernet
  connection.interface-name:              enp0s3
  connection.autoconnect:                 yes
  connection.autoconnect-priority:        0
  connection.autoconnect-retries:         -1 (default)
  connection.multi-connect:               0 (default)
  connection.auth-retries:                -1
  ...
  ```

  ```bash
  # 添加网卡配置，必须要添加的参数
  # con-name - 网卡配置名
  # type     - 网卡配置类型
  # ifname   - 网卡配置服务网卡名
  # 注1：如果一个网卡没有配置文件，那么添加之后就会直接将这个配置文件应用于这块网卡
  # 注2：如果在添加网卡配置的时候，只添加默认3个参数，该网卡地址获取参数默认DHCP
  [root@RHEL8-RHCE tutorj]$ nmcli connection add con-name test type ethernet ifname enp0s8
  Connection 'test' (476e9994-2b73-41f7-9c65-c9fd56744e3c) successfully added.
  [root@RHEL8-RHCE tutorj]$ nmcli connection show
  NAME    UUID                                  TYPE      DEVICE
  enp0s3  8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  enp0s8  ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  enp0s8
  virbr0  5cdbcd8b-09f8-4f28-affb-900db07e8088  bridge    virbr0
  test    476e9994-2b73-41f7-9c65-c9fd56744e3c  ethernet  --
  
  # add extra ipv4.addresses/ipv4.gateway/ipv4.dns
  [root@RHEL8-RHCE tutorj]$ nmcli connection add con-name test-1 type ethernet ifname enp0s8 ipv4.addresses 1.1.1.1 ipv4.gateway 1.1.1.200 ipv4.dns 114.114.114.114
  Connection 'test-1' (4b25a8f5-c848-4dae-8ff1-25966bbe0ec7) successfully added.
  [root@RHEL8-RHCE tutorj]$ nmcli connection show
  NAME    UUID                                  TYPE      DEVICE
  enp0s3  8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  enp0s8  ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  enp0s8
  virbr0  5cdbcd8b-09f8-4f28-affb-900db07e8088  bridge    virbr0
  test    476e9994-2b73-41f7-9c65-c9fd56744e3c  ethernet  --
  test-1  4b25a8f5-c848-4dae-8ff1-25966bbe0ec7  ethernet  --
  # activate test-1 -> binds to enp0s8
  [root@RHEL8-RHCE tutorj]$ nmcli connection up test-1
  Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/6)
  [root@RHEL8-RHCE tutorj]$ nmcli connection show
  NAME    UUID                                  TYPE      DEVICE
  enp0s3  8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  test-1  4b25a8f5-c848-4dae-8ff1-25966bbe0ec7  ethernet  enp0s8
  virbr0  5cdbcd8b-09f8-4f28-affb-900db07e8088  bridge    virbr0
  enp0s8  ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  --
  test    476e9994-2b73-41f7-9c65-c9fd56744e3c  ethernet  --
  [root@RHEL8-RHCE tutorj]$ nmcli device status
  DEVICE  TYPE      STATE                   CONNECTION
  enp0s3  ethernet  connected               enp0s3
  enp0s8  ethernet  connected               test-1
  virbr0  bridge    connected (externally)  virbr0
  
  # add extra ipv4.method
  [root@RHEL8-RHCE tutorj]$ nmcli connection add con-name test-2 type ethernet ifname enp0s8 ipv4.addresses 2.2.2.2 ipv4.gateway 2.2.2.200 ipv4.dns 8.8.8.8 ipv4.method manual
  [root@RHEL8-RHCE tutorj]$ nmcli connection up test-2
  Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/7)
  [root@RHEL8-RHCE tutorj]$ nmcli connection show
  NAME    UUID                                  TYPE      DEVICE
  enp0s3  8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  test-2  f04dfffa-be9e-496b-9e6b-facd46e8d416  ethernet  enp0s8
  virbr0  5cdbcd8b-09f8-4f28-affb-900db07e8088  bridge    virbr0
  enp0s8  ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  --
  test    476e9994-2b73-41f7-9c65-c9fd56744e3c  ethernet  --
  test-1  4b25a8f5-c848-4dae-8ff1-25966bbe0ec7  ethernet  --
  [root@RHEL8-RHCE tutorj]$ nmcli device status
  DEVICE  TYPE      STATE                   CONNECTION
  enp0s3  ethernet  connected               enp0s3
  enp0s8  ethernet  connected               test-2
  virbr0  bridge    connected (externally)  virbr0
  
  # changed
  [root@RHEL8-RHCE tutorj]$ nmcli device show enp0s8
  GENERAL.DEVICE:                         enp0s8
  GENERAL.TYPE:                           ethernet
  GENERAL.HWADDR:                         08:00:27:54:CE:27
  GENERAL.MTU:                            1500
  GENERAL.STATE:                          100 (connected)
  GENERAL.CONNECTION:                     test-2
  GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveConnection/7
  WIRED-PROPERTIES.CARRIER:               on
  IP4.ADDRESS[1]:                         2.2.2.2/32
  IP4.GATEWAY:                            2.2.2.200
  IP4.ROUTE[1]:                           dst = 2.2.2.200/32, nh = 0.0.0.0, mt = 101
  IP4.ROUTE[2]:                           dst = 0.0.0.0/0, nh = 2.2.2.200, mt = 101
  IP4.DNS[1]:                             8.8.8.8
  IP6.ADDRESS[1]:                         fe80::be45:3994:2634:bb52/64
  IP6.GATEWAY:                            --
  IP6.ROUTE[1]:                           dst = fe80::/64, nh = ::, mt = 1024
  [root@RHEL8-RHCE tutorj]$ ip a show enp0s8
  3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
      link/ether 08:00:27:54:ce:27 brd ff:ff:ff:ff:ff:ff
      inet 2.2.2.2/32 scope global noprefixroute enp0s8
         valid_lft forever preferred_lft forever
      inet6 fe80::be45:3994:2634:bb52/64 scope link noprefixroute
         valid_lft forever preferred_lft forever
  ```

  ```bash
  # 删除网卡配置 by NAME or UUID
  [root@RHEL8-RHCE tutorj]$ nmcli connection show
  NAME    UUID                                  TYPE      DEVICE
  enp0s3  8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  test-2  f04dfffa-be9e-496b-9e6b-facd46e8d416  ethernet  enp0s8
  virbr0  5cdbcd8b-09f8-4f28-affb-900db07e8088  bridge    virbr0
  enp0s8  ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  --
  test    476e9994-2b73-41f7-9c65-c9fd56744e3c  ethernet  --
  test-1  4b25a8f5-c848-4dae-8ff1-25966bbe0ec7  ethernet  --
  [root@RHEL8-RHCE tutorj]$ nmcli connection delete test
  Connection 'test' (476e9994-2b73-41f7-9c65-c9fd56744e3c) successfully deleted.
  [root@RHEL8-RHCE tutorj]$ nmcli connection delete 4b25a8f5-c848-4dae-8ff1-25966bbe0ec7
  Connection 'test-1' (4b25a8f5-c848-4dae-8ff1-25966bbe0ec7) successfully deleted.
  [root@RHEL8-RHCE tutorj]$ nmcli connection show
  NAME    UUID                                  TYPE      DEVICE
  enp0s3  8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  test-2  f04dfffa-be9e-496b-9e6b-facd46e8d416  ethernet  enp0s8
  virbr0  5cdbcd8b-09f8-4f28-affb-900db07e8088  bridge    virbr0
  enp0s8  ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  --
  ```

  ```bash
  # 直接编辑/etc/sysconfig/network-scripts/下的配置保存是在disk里
  # 需要重新加载让Kernel知晓,然后再激活网路配置，才能生效
  [root@RHEL8-RHCE tutorj]$ nmcli connection reload
  [root@RHEL8-RHCE tutorj]$ nmcli connection up {config}
  ```

  ```bash
  # 修改网卡配置文件
  [root@RHEL8-RHCE tutorj]$ ip a show enp0s8
  3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
      link/ether 08:00:27:54:ce:27 brd ff:ff:ff:ff:ff:ff
      inet 192.168.56.3/32 scope global noprefixroute enp0s8
         valid_lft forever preferred_lft forever
      inet6 fe80::9c99:2a33:423:f7f8/64 scope link noprefixroute
         valid_lft forever preferred_lft forever
  [root@RHEL8-RHCE tutorj]$ nmcli connection modify enp0s8 ipv4.addresses 4.4.4.4
  [root@RHEL8-RHCE tutorj]$ nmcli con up enp0s8
  Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/9)
  [root@RHEL8-RHCE tutorj]$ ip a show enp0s8
  3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
      link/ether 08:00:27:54:ce:27 brd ff:ff:ff:ff:ff:ff
      inet 4.4.4.4/32 scope global noprefixroute enp0s8
         valid_lft forever preferred_lft forever
      inet6 fe80::9c99:2a33:423:f7f8/64 scope link noprefixroute
         valid_lft forever preferred_lft forever
         
  # 开机自动加载网络配置 - auto connection
  [root@RHEL8-RHCE tutorj]$ nmcli connection modify enp0s8 connection.autoconnect no
  ```

## 4. VMware VMnet

- VMware提供3种类型的虚拟交换机`VMnet`用于虚拟机的网络连接

### 1. Host-Only

- 添加一个仅主机类型的`VMnet`后，会在host上创建一个虚拟网卡，连接到该`VMnet`

- 连接至该`VMnet`上所有虚拟机可以相互通信，但无法访问外网，即最远能通信的范围到host

  - 如果在host上配置了网卡共享就可以访问外网
  - 如果配置了静态路由也可以访问外网
  
  

![image-20230121212958298](D:\rhce8\section1\img\image-20230121212958298.png)



### 2. NAT

- 添加一个NAT类型的`VMnet`后，会在host上创建一个虚拟网卡，连接到该`VMnet`

- 仅有一个NAT类型的`VMnet`

- 连接于上的虚拟机可以相互通信，且可以访问到host能访问到的所有网络

  - 先到虚拟网卡通过NAT再到物理网卡再到外部网络
  - 虚拟机中只要将网关和DNS配置成VMnet上的网关和DNS，即使处于DHCP的pool范围之外，也可以访问外网

- 尽量让NAT类型的`VMnet`上连接的虚拟机使用DHCP获取地址和网卡和DNS

  

![image-20230121213011467](D:\rhce8\section1\img\image-20230121213011467.png)

### 3. Bridge

- ==虚拟化网络应用最多的一个类型==

- 当添加一个桥接类型的`VMnet`时，必须要指定并连接一个host上的物理网卡，可以直接访问外网

- 如果外网有DHCP，那么虚拟机可以直接分配到IP/网关/DNS

  

![image-20230121213021253](D:\rhce8\section1\img\image-20230121213021253.png)

## 5. ifconfig/ip

- `ifconfig` - configure a network interface - 早期网络管理指令，如果Linux发行版本未包含，可以通过net-tools软件包进行安装

  - 如果当前网卡有`NetworkManager`的配置文件，那么`ifconfig`配置地址不生效
  - 如果当前网卡卡没有`NetworkManager`的配置文件，那么`ifconfig`配置地址，NM会临时为网卡分配一个配置文件，重启失效

  ```bash
  # check all up inets
  ifconfig
  
  # check ip addr of inet
  ifconfig <inet>
  
  # up/down
  ifconfig <inet> up/down
  
  # set ip addr for inet
  [root@RHEL8-RHCE tutorj]$ ifconfig enp0s8 1.1.1.1/24
  [root@RHEL8-RHCE tutorj]$ ifconfig enp0s8
  enp0s8: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
          inet 1.1.1.1  netmask 255.255.255.0  broadcast 1.1.1.255
          inet6 fe80::9c99:2a33:423:f7f8  prefixlen 64  scopeid 0x20<link>
          ether 08:00:27:54:ce:27  txqueuelen 1000  (Ethernet)
          RX packets 53  bytes 7986 (7.7 KiB)
          RX errors 0  dropped 0  overruns 0  frame 0
          TX packets 41  bytes 5218 (5.0 KiB)
          TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
  
  # route has gone
  [root@RHEL8-RHCE tutorj]$ route -ne
  Kernel IP routing table
  Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
  0.0.0.0         10.0.3.1        0.0.0.0         UG        0 0          0 enp0s3
  10.0.3.0        0.0.0.0         255.255.255.0   U         0 0          0 enp0s3
  192.168.122.0   0.0.0.0         255.255.255.0   U         0 0          0 virbr0
  
  # 因为当前该网卡仍然处于UP状态，配置由nm进行管理，所以上述配置并没有生效
  [root@RHEL8-RHCE tutorj]$ nmcli con show
  NAME    UUID                                  TYPE      DEVICE
  enp0s3  8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  enp0s8  ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  enp0s8
  virbr0  f4534fd1-4c49-4721-aab5-0cecac1cba2a  bridge    virbr0
  
  # 使之脱离nm的管理
  [root@RHEL8-RHCE tutorj]$ nmcli con down enp0s8
  Connection 'enp0s8' successfully deactivated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/2)
  [root@RHEL8-RHCE tutorj]$ nmcli con show
  NAME    UUID                                  TYPE      DEVICE
  enp0s3  8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  virbr0  f4534fd1-4c49-4721-aab5-0cecac1cba2a  bridge    virbr0
  enp0s8  ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  --
  
  # 此时检查发现IP没了，因为没有任何配置文件关联，那是肯定没有IP的
  [root@RHEL8-RHCE tutorj]$ ifconfig enp0s8
  enp0s8: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
          ether 08:00:27:54:ce:27  txqueuelen 1000  (Ethernet)
          RX packets 53  bytes 7986 (7.7 KiB)
          RX errors 0  dropped 0  overruns 0  frame 0
          TX packets 46  bytes 5648 (5.5 KiB)
          TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
  
  # 此时再添加
  [root@RHEL8-RHCE tutorj]$ ifconfig enp0s8 1.1.1.1/24
  [root@RHEL8-RHCE tutorj]$ ifconfig enp0s8
  enp0s8: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
          inet 1.1.1.1  netmask 255.255.255.0  broadcast 1.1.1.255
          ether 08:00:27:54:ce:27  txqueuelen 1000  (Ethernet)
          RX packets 53  bytes 7986 (7.7 KiB)
          RX errors 0  dropped 0  overruns 0  frame 0
          TX packets 53  bytes 6404 (6.2 KiB)
          TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
  
  # nm自动感知ifconfig的操作enp0s8增加一个配置并UP
  # 该配置是临时的，如果重启了则消失
  [root@RHEL8-RHCE tutorj]$ nmcli con show
  NAME    UUID                                  TYPE      DEVICE
  enp0s3  8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  enp0s8  26d624d8-9bbc-4289-8ad5-e3375f98221d  ethernet  enp0s8
  virbr0  f4534fd1-4c49-4721-aab5-0cecac1cba2a  bridge    virbr0
  enp0s8  ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  --
  
  # 路由表同时也新增了一条enp0s8路由
  [root@RHEL8-RHCE tutorj]$ route -ne
  Kernel IP routing table
  Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
  0.0.0.0         10.0.3.1        0.0.0.0         UG        0 0          0 enp0s3
  1.1.1.0         0.0.0.0         255.255.255.0   U         0 0          0 enp0s8
  10.0.3.0        0.0.0.0         255.255.255.0   U         0 0          0 enp0s3
  192.168.122.0   0.0.0.0         255.255.255.0   U         0 0          0 virbr0
  ```

- `ip` show / manipulate routing, network devices, interfaces and tunnels - 基本取代`ifconfig`

  - 如果当前网卡有`NetworkManager`的配置文件，那么`ip`配置地址是立即生效的，但重启也会失效
    - 一般不使用这种纯软件的方式让一个网卡获得多个IP
  
```bash
  # check all up inets
  ip a
  
  # check ip addr of inet
  ip a show <inet>
  
  # up/down inet
  ip link set <inet> up/down
  
  # show route table
  [tutorj@RHEL8-RHCE ~]$ ip route show
  default via 10.0.3.1 dev enp0s3 proto dhcp src 10.0.3.4 metric 100
  default via 192.168.56.1 dev enp0s8 proto static metric 101
  10.0.3.0/24 dev enp0s3 proto kernel scope link src 10.0.3.4 metric 100
  192.168.56.1 dev enp0s8 proto static scope link metric 101
  192.168.122.0/24 dev virbr0 proto kernel scope link src 192.168.122.1 linkdown
  
  # flush ip of inet
  [root@RHEL8-RHCE tutorj]$ ip a show enp0s8
  3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
      link/ether 08:00:27:54:ce:27 brd ff:ff:ff:ff:ff:ff
      inet 192.168.56.3/32 scope global noprefixroute enp0s8
         valid_lft forever preferred_lft forever
      inet6 fe80::9c99:2a33:423:f7f8/64 scope link noprefixroute
         valid_lft forever preferred_lft forever
  [root@RHEL8-RHCE tutorj]$ ip a flush enp0s8
  [root@RHEL8-RHCE tutorj]$ ip a show enp0s8
  3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
      link/ether 08:00:27:54:ce:27 brd ff:ff:ff:ff:ff:ff
      inet6 fe80::1588:2625:1e99:f807/64 scope link noprefixroute
         valid_lft forever preferred_lft foreve
  [root@RHEL8-RHCE tutorj]$ nmcli con up enp0s8
  Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/4)
  [root@RHEL8-RHCE tutorj]$ ip a show enp0s8
  3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
      link/ether 08:00:27:54:ce:27 brd ff:ff:ff:ff:ff:ff
      inet 192.168.56.3/32 scope global noprefixroute enp0s8
         valid_lft forever preferred_lft forever
      inet6 fe80::9c99:2a33:423:f7f8/64 scope link noprefixroute
         valid_lft forever preferred_lft forever
  
  # add ip to inet
  [root@RHEL8-RHCE tutorj]$ ip a add 1.1.1.1/24 dev enp0s8
  [root@RHEL8-RHCE tutorj]$ ip a show enp0s8
  3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
      link/ether 08:00:27:54:ce:27 brd ff:ff:ff:ff:ff:ff
      inet 192.168.56.3/32 scope global noprefixroute enp0s8
         valid_lft forever preferred_lft forever
      inet 1.1.1.1/24 scope global enp0s8                           # added
         valid_lft forever preferred_lft forever
      inet6 fe80::9c99:2a33:423:f7f8/64 scope link noprefixroute
         valid_lft forever preferred_lft forever
  [root@RHEL8-RHCE tutorj]$ route -ne
  Kernel IP routing table
  Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
  0.0.0.0         10.0.3.1        0.0.0.0         UG        0 0          0 enp0s3
  0.0.0.0         192.168.56.1    0.0.0.0         UG        0 0          0 enp0s8
  1.1.1.0         0.0.0.0         255.255.255.0   U         0 0          0 enp0s8   # added
  10.0.3.0        0.0.0.0         255.255.255.0   U         0 0          0 enp0s3
  192.168.56.1    0.0.0.0         255.255.255.255 UH        0 0          0 enp0s8
  192.168.122.0   0.0.0.0         255.255.255.0   U         0 0          0 virbr0
  [root@RHEL8-RHCE tutorj]$ nmcli con show enp0s8 | grep IP4.ADDRESS
  IP4.ADDRESS[1]:                         1.1.1.1/24                   # added
  IP4.ADDRESS[2]:                         192.168.56.3/32
```


## 6. netstat/ss

- `netstat` - print network connections, routing tables, interface statistics, masquerade connections, and multicast memberships

  ```bash
  # commonly used
  netstat -tunlp
  ```

  ```bash
  # -a - display all socket （监听和未监听的）
  netstat -a 
  
  # -t - tcp
  # -u - udp
  netstat -at
  netstat -au
  ```

  ```bash
  # -a - display listening server sockets
  # -x - UNIX port
  netstat -l
  netstat -lt
  netstat -lu
  netstat -lx
  ```

  ```bash
  # -s - display networking statistics
  netstat -s
  netstat -st
  netstat -su
  netstat -sx
  ```

  ```bash
  # -p - show PID
  netstat -p
  netstat -pt
  netstat -pu
  netstat -px
  ```

  ```bash
  # -n - don't resolve names
  # --numeric-hosts          don't resolve host names
  # --numeric-ports          don't resolve port names
  # --numeric-users          don't resolve user names
  netstat -an
  netstat -a --numeric-hosts
  netstat -a --numeric-ports
  netstat -a --numeric-users | head
  ```

  ```bash
  # -c - continuous listing
  netstat -n
  ```

  ```bash
  # -r - show route table
  netstat -r
  netstat -rn
  ```

  ```bash
  # find which port a process/service is using
  netstat -anp | grep ssh
  
  # find process service by port
  netstat -anp | grep ':80'
  
  # 通过端口找进程ID
  netstat -anp | grep ':80' | grep LISTEN | awk '{print $7}' | cut -d/ -f1
  ```

  ```bash
  # -i - display interface table
  netstat -i
  # = ifconfig
  netstat -ie
  ```

  ```bash
  # 查看已建立的连接
  netstat -ntu
  
  # 查看某服务器端口最多的IP地址
  netstat -ntu | grep :22 | awk '{print $5}' | cut -d: -f1 | awk '{++ip[$i]} END {for(i in ip)print ip[i],"\t",i}' | sort -nr
  
  # 查看TCP连接的状态
  netstat -nt | grep -v -e 127.0.0.1 -e 0.0.0.0 -e ::: | awk '/^tcp/ {++state[$NF]} END {for(i in state)print i,"\t",state[i]}'
  
  # 查看phpcgi进程数，如果接近预设值，说明不够用
  netstat -anpo | grep "php-cgi" | wc -l
  ```

- `ss` - another utility to investigate sockets, better than `netstat`

  - 优势在于它能显示更多更详细有关TCP和连接状态的信息，比`netstat`更快速更高效
  - 当socket连接数量非常大时，无论时`netstat`还是`cat /proc/net/tcp`执行速度都会很慢
  - `ss`使用网络栈中的`tcp_diag`分析统计的模块，能获得`Kernel`第一手的信息，效率杠杠的
  
  ```bash
  # compare
  [root@RHEL8-RHCE tutorj]$ time netstat -at 
  real    0m0.079s
  user    0m0.010s
  sys     0m0.004s
  [root@RHEL8-RHCE tutorj]$ time ss
  real    0m0.012s
  user    0m0.006s
  sys     0m0.004s
  
  # -a - all socket
  # -t - only tcp
  # -u - only udp
  ss -at
  ss -at
  
  # -s - show socket usage summary
  ss -s
  
  # -l - listening socket
  # -p - show process using socket
  ss -l
  ss -lp
  ss -lp | grep PID
  ```
  
  ```bash
  # 匹配本地/远程
  ss src 1.2.3.4
  ss src 1.2.3.4:http
  ss src 1.2.3.4:80
  
  ss dst 5.6.7.8
  ss dst 5.6.7.8:https
  ss dst 5.6.7.8:443
  ```
  
  ```bash
  # 端口比较
  # OP - option
  # <= or le
  # >= or ge
  # == or eq
  # != or ne
  # <  or gt
  # >  or lt
  ss dport OP PORT
  ss sport OP PORT
  
  ss sport = :http
  ss dport = :http
  
  ss dport >= :1024
  ss sport <= :32000
  
  ss sport eq :22
  ss dport != :22
  
  # 查看源端口为80，已建立连接的连接
  ss state connected sport = :http
  
  # 查看源端口为80/443的连接
  ss '( sport = :http or sport = https )'
  
  # -o - show timer information
  # 列出所有状态为established的SMTP/HTTP连接
  ss -o state established '( dport = :smtp or sport = :smtp )'
  ss -o state established '( dport = :http or sport = :http )'
  
  # 列出所有处于FIN-WAIT-1状态源端口为80/443，目标地址为1.2.3.4的连接
  ss -o state fin-wait-1 '( sport = :http or sport = :https )' dst 1.2.3.4 
  ```
  
  ```bash
  # 根据连接状态过滤
  # -4 - ipv4
  # -6 - ipv6
  ss -4 state <STATE>
  ss -6 state <STATE>
  
  # STATE
  # established, syn-sent, syn-recv, fin-wait-1, fin-wait-2, time-wait, closed, close-wait, last-ack, listening and closing.
  # all - for all the states
  # connected - all the states except for listening and closed
  # synchronized - all the connected states except for syn-sent
  # bucket - states, which are maintained as minisockets, i.e.  time-wait and syn-recv
  # big - opposite to bucket
  ```

## 7. VLAN

- 虚拟化网络 - 将物理`LAN`划分成多个逻辑`LAN`

- 服务器出向网卡桥接外部交换机要设置成`Trunk`模式 - 可以识别`VLAN` tag = 支持多个`VLAN`传输，因为服务器内可能存在多个`VLAN`

- 如果交换机的口设置成`Access`模式，那么会自动丢弃带tag的host上虚拟机的包

  ```bash
  # 添加vlan虚拟网卡，自动创建网卡和对应配置
  [root@RHEL8-RHCE tutorj]$ nmcli con add con-name enp0s3vlan10 ifname enp0s3-vlan10 type vlan id 10 dev enp0s3 ipv4.addresses 10.10.10.1/24 ipv4.method manual
  Connection 'enp0s3vlan10' (6535f043-48ef-4c93-9cbb-cf6fc0c7cee0) successfully added.
  [root@RHEL8-RHCE tutorj]$ nmcli device status
  DEVICE         TYPE      STATE                   CONNECTION
  enp0s3         ethernet  connected               enp0s3
  enp0s8         ethernet  connected               enp0s8
  enp0s3-vlan10  vlan      connected               enp0s3vlan10
  virbr0         bridge    connected (externally)  virbr0
  lo             loopback  unmanaged               --
  [root@RHEL8-RHCE tutorj]$ nmcli con show
  NAME          UUID                                  TYPE      DEVICE
  enp0s3        8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  enp0s3vlan10  6535f043-48ef-4c93-9cbb-cf6fc0c7cee0  vlan      enp0s3-vlan10
  enp0s8        ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  enp0s8
  virbr0        3cf438eb-4c54-409a-9291-ffb8fe97da70  bridge    virbr0
  ```

  

  <img src="D:\rhce8\section1\img\image-20230122103505195.png" alt="image-20230122103505195" style="zoom: 50%;" />

  

  <img src="D:\rhce8\section1\img\image-20230122104708726.png" alt="image-20230122104708726" style="zoom:50%;" />

## 8. route

- 服务器as路由器；两者都可以收发数据，但路由器具备转发功能，服务器默认不开启

- `route` - show / manipulate the IP routing table

  ```bash
  # -n - show numerical addresses
  [tutorj@RHEL8-RHCE ~]$ route -n
  Kernel IP routing table
  Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
  0.0.0.0         10.0.3.1        0.0.0.0         UG    100    0        0 enp0s3
  0.0.0.0         192.168.56.1    0.0.0.0         UG    101    0        0 enp0s8
  10.0.3.0        0.0.0.0         255.255.255.0   U     100    0        0 enp0s3
  192.168.56.1    0.0.0.0         255.255.255.255 UH    101    0        0 enp0s8
  192.168.122.0   0.0.0.0         255.255.255.0   U     0      0        0 virbr0
  
  # -e - use netstat-format
  [tutorj@RHEL8-RHCE ~]$ route -ne
  Kernel IP routing table
  Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
  0.0.0.0         10.0.3.1        0.0.0.0         UG        0 0          0 enp0s3
  0.0.0.0         192.168.56.1    0.0.0.0         UG        0 0          0 enp0s8
  10.0.3.0        0.0.0.0         255.255.255.0   U         0 0          0 enp0s3
  192.168.56.1    0.0.0.0         255.255.255.255 UH        0 0          0 enp0s8
  192.168.122.0   0.0.0.0         255.255.255.0   U         0 0          0 virbr0
  ```
  
  ```bash
  # 创建网卡配置给予网关地址即可
  nmcli con add con-name enp0s3 ifname enp0s3 type ethernet ipv4.addresses 1.1.1.10/24 ipv4.method man
  nmcli con add con-name enp0s8 ifname enp0s8 type ethernet ipv4.addresses 2.2.2.10/24 ipv4.method man
  
  # 临时开启服务器转发功能，默认关闭
  [root@RHEL8-RHCE tutorj]$ echo 1 > /proc/sys/net/ipv4/ip_forward
  [root@RHEL8-RHCE tutorj]$ cat /proc/sys/net/ipv4/ip_forward
  1
  
  # 永久并立即生效
  [root@RHEL8-RHCE tutorj]$ vi /etc/sysctl.conf
  [root@RHEL8-RHCE tutorj]$ cat /etc/sysctl.conf
  # sysctl settings are defined through files in
  # /usr/lib/sysctl.d/, /run/sysctl.d/, and /etc/sysctl.d/.
  #
  # Vendors settings live in /usr/lib/sysctl.d/.
  # To override a whole file, create a new file with the same in
  # /etc/sysctl.d/ and put new settings there. To override
  # only specific settings, add a file with a lexically later
  # name in /etc/sysctl.d/ and put new settings there.
  #
  # For more information, see sysctl.conf(5) and sysctl.d(5).
  net.ipv4.ip_forward=1	# add
  [root@RHEL8-RHCE tutorj]$ sysctl -p
  net.ipv4.ip_forward = 1
  ```
  
  ```bash
  # Centos -> Win 通过内网
  # Win -> Centos OK
  # Centos -> Win NOK因为没有路由表，所以需要添加路由 - gw is next jump
  # 内部网络添加静态路由，外部网络使用缺省路由
  route add -net 192.160.20.0/24 gw 192.168.10.20
  ```
  
  
  
  <img src="D:\rhce8\section1\img\image-20230122105131227.png" alt="image-20230122105131227" style="zoom:50%;" />
  
  
  
  <img src="D:\rhce8\section1\img\image-20230122105317733.png" alt="image-20230122105317733" style="zoom:50%;" />
  
  
  
  <img src="D:\rhce8\section1\img\image-20230122110828832.png" alt="image-20230122110828832" style="zoom:50%;" />

## 9. bond

- 链路聚合 - 多条物理链路绑定成一条逻辑链路，提高带宽，增加冗余性；比如一台服务器两张网卡进行绑定分别连到两台交换机上

  ```bash
  # create bond - 
  [root@RHEL8-RHCE tutorj]$ nmcli con add con-name bond0 ifname bond0 type bond mode active-backup
  Connection 'bond0' (443f7237-1ddf-4bd5-be8c-0dfdd380fc09) successfully added.
  [root@RHEL8-RHCE tutorj]$ nmcli device status
  DEVICE         TYPE      STATE                                  CONNECTION
  enp0s3         ethernet  connected                              enp0s3
  enp0s8         ethernet  connected                              enp0s8
  enp0s3-vlan10  vlan      connected                              enp0s3vlan10
  virbr0         bridge    connected (externally)                 virbr0
  bond0          bond      connecting (getting IP configuration)  bond0	# add
  lo             loopback  unmanaged                              --
  [root@RHEL8-RHCE tutorj]$ nmcli con show
  NAME          UUID                                  TYPE      DEVICE
  bond0         443f7237-1ddf-4bd5-be8c-0dfdd380fc09  bond      bond0		# add
  enp0s3        8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  enp0s3vlan10  6535f043-48ef-4c93-9cbb-cf6fc0c7cee0  vlan      enp0s3-vlan10
  enp0s8        ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  enp0s8
  virbr0        c4cfc7b7-9c14-4119-9367-b1c5ba10b700  bridge    virbr0
  
  # add devices into bond
  [root@RHEL8-RHCE tutorj]$ nmcli con add con-name bond0-1 ifname enp0s3 type bond-slave master bond0
  Connection 'bond0-1' (18d0456f-7a7f-42a8-83e7-16ffdcabae09) successfully added.
  [root@RHEL8-RHCE tutorj]$ nmcli con add con-name bond0-2 ifname enp0s8 type bond-slave master bond0
  Connection 'bond0-2' (bd122bc1-53bb-4432-8588-36f20cc461af) successfully added.
  [root@RHEL8-RHCE tutorj]$ nmcli con show
  NAME          UUID                                  TYPE      DEVICE
  bond0         443f7237-1ddf-4bd5-be8c-0dfdd380fc09  bond      bond0
  enp0s3        8e17842e-3d41-4cc0-b635-cd2b85fc5787  ethernet  enp0s3
  enp0s3vlan10  6535f043-48ef-4c93-9cbb-cf6fc0c7cee0  vlan      enp0s3-vlan10
  enp0s8        ecdbabdf-c2ad-4f59-b506-25107eac57b3  ethernet  enp0s8
  virbr0        c4cfc7b7-9c14-4119-9367-b1c5ba10b700  bridge    virbr0
  bond0-1       18d0456f-7a7f-42a8-83e7-16ffdcabae09  ethernet  --	# add
  bond0-2       bd122bc1-53bb-4432-8588-36f20cc461af  ethernet  --	# add
  
  
  # check bond
  [root@RHEL8-RHCE tutorj]$ cat /proc/net/bonding/bond0
  Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)
  
  Bonding Mode: fault-tolerance (active-backup)
  Primary Slave: None
  Currently Active Slave: None
  MII Status: down
  MII Polling Interval (ms): 100
  Up Delay (ms): 0
  Down Delay (ms): 0
  Peer Notification Delay (ms): 0
  
  # set ip for bond
  [root@RHEL8-RHCE tutorj]$ nmcli connection modify bond0 ipv4.addresses 1.1.1.1/24 ip.method manual
  ```

  <img src="D:\rhce8\section1\img\image-20230122142452650.png" alt="image-20230122142452650" style="zoom:50%;" />

  ## Extra

  ### 1. bond & vlan

  ### 2. 服务器网卡功能和分配方案

