[toc]

# RPM & YUM

## 1. Package Management

### 1. Overview

- `Windows`：开发源码 -> 编译（成机器语言） -> 平台发布 -> 用户下载直接安装（而不需要进行编译）- exe/msi/setup
- `Linux`
  - 源码包安装 - 可以更改源码 + 相比于编译好的二进制包更新，功能更多
  - 二进制安装 - 常用
  - 发行版本软件包后缀
    - **RHEL/CentOS/Fedora - .rpm  - yum（dnf）** 
    - openSUSE/SELS      - .rpm  - zypper
    - Debian/Ubuntu      - .dpkg - opt
  - 本质上只要软件包的架构和CPU的架构匹配就可以安装 - RHEL也能安装.deb的软件包，可能需要额外的软件包管理工具

### 2. rpm

- 系统安装镜像iso中就包含rpm包

  ```bash
  hiron@DESKTOP-MRRKMSM MINGW64 /g/BaseOS/Packages
  $ ll | head
  total 1191596
  -r--r--r-- 1 hiron 197609    151876 12 15  2018 aajohan-comfortaa-fonts-3.001-2.el8.noarch.rpm
  -r--r--r-- 1 hiron 197609     67832  1 28  2021 accel-config-2.8-1.el8.i686.rpm
  -r--r--r-- 1 hiron 197609     65024  1 28  2021 accel-config-2.8-1.el8.x86_64.rpm
  -r--r--r-- 1 hiron 197609     40992  1 28  2021 accel-config-libs-2.8-1.el8.i686.rpm
  -r--r--r-- 1 hiron 197609     40128  1 28  2021 accel-config-libs-2.8-1.el8.x86_64.rpm
  -r--r--r-- 1 hiron 197609     82976 12 15  2018 acl-2.2.53-1.el8.x86_64.rpm
  -r--r--r-- 1 hiron 197609   1022540 12 15  2018 acpica-tools-20180629-3.el8.x86_64.rpm
  -r--r--r-- 1 hiron 197609    117344 12 22  2020 adcli-0.8.2-9.el8.x86_64.rpm
  -r--r--r-- 1 hiron 197609     62656 12 22  2020 adcli-doc-0.8.2-9.el8.noarch.rpm
  ```

- How to read package name?

  ```bash
  # 软件名：xfsprogs - xfsprogs-devel为辅助包，却决于主包是否依赖；如果依赖，则要先装辅助包再装主包
  # 版本：5.0.0
  # 8 - 发行次数
  # 适用的操作系统：el8 -> RHEL8
  # x86/i686/i386 - 32位CPU架构
  # x86_64        - 64位CPU架构
  # noarch        - 适用任何CPU架构
  xfsprogs-5.0.0-8.el8.i686.rpm
  xfsprogs-5.0.0-8.el8.x86_64.rpm
  xfsprogs-devel-5.0.0-8.el8.i686.rpm
  xfsprogs-devel-5.0.0-8.el8.x86_64.rpm
  ```

- mount iso

  ```bash
  [root@RHEL8-RHCE tutorj]$ mkdir /iso
  [root@RHEL8-RHCE tutorj]$ mount /dev/sr1 /iso
  mount: /iso: WARNING: device write-protected, mounted read-only.
  [root@RHEL8-RHCE tutorj]$ ll /iso
  total 48
  dr-xr-xr-x. 4 root root  2048 Jul  1  2022 AppStream
  dr-xr-xr-x. 4 root root  2048 Jul  1  2022 BaseOS
  dr-xr-xr-x. 3 root root  2048 Jul  1  2022 EFI
  -r--r--r--. 1 root root  8154 Jul  1  2022 EULA
  -r--r--r--. 1 root root  1455 Jul  1  2022 extra_files.json
  -r--r--r--. 1 root root 18092 Jul  1  2022 GPL
  dr-xr-xr-x. 3 root root  2048 Jul  1  2022 images
  dr-xr-xr-x. 2 root root  2048 Jul  1  2022 isolinux
  -r--r--r--. 1 root root   103 Jul  1  2022 media.repo
  -r--r--r--. 1 root root  1669 Jul  1  2022 RPM-GPG-KEY-redhat-beta
  -r--r--r--. 1 root root  5134 Jul  1  2022 RPM-GPG-KEY-redhat-release
  -r--r--r--. 1 root root  1796 Jul  1  2022 TRANS.TBL
  [root@RHEL8-RHCE Packages]$ ll | grep xz
  -r--r--r--.  852 root root    156848 Nov 22  2018 xz-5.2.4-3.el8.x86_64.rpm
  -r--r--r--.  794 root root     63992 Nov 22  2018 xz-devel-5.2.4-3.el8.i686.rpm
  -r--r--r--.  794 root root     63972 Nov 22  2018 xz-devel-5.2.4-3.el8.x86_64.rpm
  -r--r--r--.  794 root root    104628 Nov 22  2018 xz-libs-5.2.4-3.el8.i686.rpm
  -r--r--r--.  852 root root     96192 Nov 22  2018 xz-libs-5.2.4-3.el8.x86_64.rpm
  ```

- install/uninstall

  - dependency - can't be more digusting
    - tree   - A <- B <- C
    - loop   - A <- B <- C <- A
    - module - A <- B.module

  ```bash
  # install
  # -i      - install
  # -v      - verbose
  # -h      - progress
  # --force - force
  [root@RHEL8-RHCE Packages]$ rpm -ivh xz-libs-5.2.4-3.el8.x86_64.rpm
  Verifying...                          ################################# [100%]
  Preparing...                          ################################# [100%]
  package xz-libs-5.2.4-4.el8_6.x86_64 (which is newer than xz-libs-5.2.4-3.el8.x86_64) is already installed
  
  # uninstall
  # -e - erase
  [root@RHEL8-RHCE Packages]$ rpm -evh xz
  error: Failed dependencies:
          xz is needed by (installed) libreport-2.9.5-15.el8.x86_64
          xz is needed by (installed) gettext-devel-0.19.8.1-17.el8.x86_64
          xz is needed by (installed) rpm-build-4.14.3-24.el8_7.x86_64
          xz is needed by (installed) dracut-049-209.git20220815.el8.x86_64
          xz is needed by (installed) sos-4.3-5.el8.noarch
          xz is needed by (installed) pcp-5.3.7-7.el8.x86_64
          xz is needed by (installed) libvirt-daemon-driver-qemu-8.0.0-10.module+el8.7.0+16689+53d59bc2.x86_64
          xz is needed by (installed) sysstat-11.7.3-7.el8.x86_64
          /usr/bin/xz is needed by (installed) file-roller-3.28.1-4.el8.x86_64
  ```

- Basic cmd

  ```bash
  # 查看已安装的软件包信息
  # -q - query
  # -i - information
  [root@RHEL8-RHCE Packages]$ rpm -qi xz
  Name        : xz
  Version     : 5.2.4
  Release     : 4.el8_6
  Architecture: x86_64
  Install Date: Tue 13 Dec 2022 10:59:51 PM CST
  Group       : Unspecified
  Size        : 424234
  License     : GPLv2+ and Public Domain
  Signature   : RSA/SHA256, Mon 06 Jun 2022 06:38:15 PM CST, Key ID 199e2f91fd431d51
  Source RPM  : xz-5.2.4-4.el8_6.src.rpm
  Build Date  : Tue 31 May 2022 10:16:15 PM CST
  Build Host  : x86-64-01.build.eng.rdu2.redhat.com
  Relocations : (not relocatable)
  Packager    : Red Hat, Inc. <http://bugzilla.redhat.com/bugzilla>
  Vendor      : Red Hat, Inc.
  URL         : http://tukaani.org/xz/
  Summary     : LZMA compression utilities
  Description :
  XZ Utils are an attempt to make LZMA compression easy to use on free (as in
  freedom) operating systems. This is achieved by providing tools and libraries
  which are similar to use than the equivalents of the most popular existing
  compression algorithms.
  
  LZMA is a general purpose compression algorithm designed by Igor Pavlov as
  part of 7-Zip. It provides high compression ratio while keeping the
  decompression speed fast.
  
  # 查看未安装的软件包信息
  # -p - package
  [root@RHEL8-RHCE Packages]$ rpm -qpi xz-libs-5.2.4-3.el8.x86_64.rpm
  Name        : xz-libs
  Version     : 5.2.4
  Release     : 3.el8
  Architecture: x86_64
  Install Date: (not installed)
  Group       : Unspecified
  Size        : 194791
  License     : Public Domain
  Signature   : RSA/SHA256, Thu 22 Nov 2018 10:30:15 PM CST, Key ID 199e2f91fd431d51
  Source RPM  : xz-5.2.4-3.el8.src.rpm
  Build Date  : Thu 22 Nov 2018 10:08:28 PM CST
  Build Host  : x86-vm-01.build.eng.bos.redhat.com
  Relocations : (not relocatable)
  Packager    : Red Hat, Inc. <http://bugzilla.redhat.com/bugzilla>
  Vendor      : Red Hat, Inc.
  URL         : http://tukaani.org/xz/
  Summary     : Libraries for decoding LZMA compression
  Description :
  Libraries for decoding files compressed with LZMA or XZ utils.
  
  # list all installed packages
  [root@RHEL8-RHCE Packages]$ rpm -qa | head -3
  asciidoc-8.6.10-0.5.20180627gitf7c2274.el8.noarch
  oddjob-0.34.7-2.el8.x86_64
  iproute-5.18.0-1.el8.x86_64
  [root@RHEL8-RHCE Packages]$ rpm -qa | grep xz
  xz-libs-5.2.4-4.el8_6.x86_64
  xz-devel-5.2.4-4.el8_6.x86_64
  xz-5.2.4-4.el8_6.x86_64
  
  # list all files of installed package
  # -l - list
  [root@RHEL8-RHCE Packages]$ rpm -ql xz | head -5
  /etc/profile.d/colorxzgrep.csh
  /etc/profile.d/colorxzgrep.sh
  /usr/bin/unxz
  /usr/bin/xz
  /usr/bin/xzcat
  
  # list all files in a package
  [root@RHEL8-RHCE Packages]$ rpm -qpl xz-libs-5.2.4-3.el8.x86_64.rpm | head -5
  /usr/lib/.build-id
  /usr/lib/.build-id/08
  /usr/lib/.build-id/08/3f716669d880bb6f73b951cc9520ef11f0c188
  /usr/lib64/liblzma.so.5
  /usr/lib64/liblzma.so.5.2.4
  
  # 根据命令反推是由哪个包安装的
  # -f - from package
  [root@RHEL8-RHCE Packages]$ rpm -qf /bin/rm
  coreutils-8.30-13.el8.x86_64
  ```

### 3. yum

- `yum` - yelow dog updator manager - `rpm`的管理工具，解决安装包之间的依赖问题，通过`repo`中记录的`rpm`的`metadata`来找到所有依赖的`rpm`

  - 将`repo`中记录的`metadata`下载下来缓存倒本地
  - `repo`的本质/条件：`rpm` + `metadata`

  ```bash
  [root@RHEL8-RHCE iso]$ tree -d
  .
  ├── AppStream
  │   ├── Packages	# rpm
  │   └── repodata    # repo - xml
  ├── BaseOS
  │   ├── Packages	# rpm 
  │   └── repodata    # repo - xml
  ├── EFI
  │   └── BOOT
  │       └── fonts
  ├── images
  │   └── pxeboot
  └── isolinux
  
  ```

- Build a repo (using iso) - 将其中的`rpm`和`metadata`放到指定路径，然后`yum`指定该路径

  ```bash
  # yum config
  [root@RHEL8-RHCE iso]$ cat /etc/yum.conf
  [main]
  gpgcheck=1
  installonly_limit=3
  clean_requirements_on_remove=True
  best=True
  skip_if_unavailable=False
  
  # repo dir
  [root@RHEL8-RHCE iso]$ cd /etc/yum.repos.d/
  [root@RHEL8-RHCE yum.repos.d]$ ll
  total 420
  -rw-r--r--. 1 root root   2590 Dec 14 22:26 CentOS-Base.repo
  -rw-r--r--. 1 root root   1480 Jun  8  2021 epel-modular.repo
  -rw-r--r--. 1 root root   1562 Jun  8  2021 epel-playground.repo
  -rw-r--r--. 1 root root   1417 Jun  8  2021 epel.repo
  -rw-r--r--. 1 root root   1579 Jun  8  2021 epel-testing-modular.repo
  -rw-r--r--. 1 root root   1516 Jun  8  2021 epel-testing.repo
  -rw-r--r--. 1 root root 203170 Jan 23 15:43 redhat.repo
  -rw-r--r--. 1 root root 196288 Dec 13 23:26 redhat.repo.bak
  -rw-r--r--. 1 root root    124 Dec 26 10:52 root_local_repo.repo
  
  # create a repo
  [root@RHEL8-RHCE yum.repos.d]$ cat iso.repo
  [ios]
  name = iso's repo
  enable = yes
  gpgcheck = 0
  baseurl = file:///iso/BaseOS    # baseurl is a location points to repodata
  enabled = 0                     # 默认仓库创建完是开启的
  
  # check repo
  [root@RHEL8-RHCE yum.repos.d]$ yum repolist | grep ios
  repo id                          repo name
  ios                              iso's repo
  
  [root@RHEL8-RHCE yum.repos.d]$ du -sh /iso/BaseOS/repodata/
  3.1M    /iso/BaseOS/repodata/
  
  # list all rpm from all repo & make cache - 有了cache之后，安装时可以进行补全
  [root@RHEL8-RHCE yum.repos.d]$ yum list 
  # list all rpm in repo
  [root@RHEL8-RHCE yum.repos.d]$ yum list iso
  
  
  # 清除缓存，此时无法补全
  [root@RHEL8-RHCE yum.repos.d]$ yum clean all
  68 files removed
  
  # 手动生成缓存
  [root@RHEL8-RHCE yum.repos.d]$ yum makecache
  [root@RHEL8-RHCE yum.repos.d]$ yum makecache
  CentOS-8 - Base - mirrors.aliyun.com                        658 kB/s | 4.6 MB     00:07
  CentOS-8 - Extras - mirrors.aliyun.com                      20 kB/s  |  10 kB     00:00
  CentOS-8 - AppStream - mirrors.aliyun.com                   456 kB/s | 8.4 MB     00:18
  Extra Packages for Enterprise Linux 8 - x86_64              4.6 MB/s |  13 MB     00:02
  Extra Packages for Enterprise Linux Modular 8 - x86_64      377 kB/s | 733 kB     00:01
  iso repo                                                    31 MB/s  | 2.3 MB     00:00
  Red Hat Enterprise Linux 8 for x86_64 - AppStream (RPMs)    157 kB/s |  52 MB     05:38
  Red Hat Enterprise Linux 8 for x86_64 - BaseOS (RPMs)       165 kB/s |  56 MB     05:47
  created by dnf config-manager from file:///root/local_repo  5.1 kB/s | 257  B     00:00
  Metadata cache created.
  
  # find rpm with keyword from all repo
  [root@RHEL8-RHCE yum.repos.d]$ yum search core | head
  Last metadata expiration check: 0:11:23 ago on Tue 24 Jan 2023 09:37:09 AM CST.
  ========================= Name & Summary Matched: core =========================
  R-core-devel.x86_64 : Core files for development of R packages (no Java)
  abrt-addon-coredump-helper.x86_64 : abrt's /proc/sys/kernel/core_pattern helper
  abrt-addon-vmcore.x86_64 : abrt's vmcore addon
  acme-tiny-core.noarch : Core python module of acme-tiny
  anaconda-core.x86_64 : Core of the Anaconda installer
  aspnetcore-runtime-3.0.x86_64 : ASP.NET Core 3.0 runtime
  aspnetcore-runtime-3.1.x86_64 : ASP.NET Core 3.1 runtime
  aspnetcore-runtime-5.0.x86_64 : ASP.NET Core 5.0 runtime
  aspnetcore-runtime-6.0.x86_64 : ASP.NET Core 6.0 runtime
  
  
  # find which repo provides rm
  [root@RHEL8-RHCE yum.repos.d]$ yum provides rm
  Last metadata expiration check: 0:12:04 ago on Tue 24 Jan 2023 09:37:09 AM CST.
  coreutils-8.30-6.el8.x86_64 : A set of basic GNU tools commonly used in shell scripts
  Repo        : rhel-8-for-x86_64-baseos-rpms
  Matched from:
  Filename    : /usr/bin/rm
  Provide    : /bin/rm
  
  coreutils-8.30-6.el8_1.1.x86_64 : A set of basic GNU tools commonly used in shell scripts
  Repo        : rhel-8-for-x86_64-baseos-rpms
  Matched from:
  Filename    : /usr/bin/rm
  Provide    : /bin/rm
  
  
  # install /uninstall
  yum install <pkg-name>
  yum uninstall <pkg-name>
  ```

- Using repo from [Internet](https://mirrors.tuna.tsinghua.edu.cn/centos/8/extras/x86_64/os/)

  - 对于RHEL还是建议订阅连接Redhat官方软件仓库

  ```bash
  [root@RHEL8-RHCE yum.repos.d]$ cat tsinghua.repo
  [tsinghua]
  name = tsinghua
  enable = yes
  gpgcheck = 0
  baseurl = https://mirrors.tuna.tsinghua.edu.cn/centos/8/extras/x86_64/os/  # url
  
  [root@RHEL8-RHCE yum.repos.d]$ yum repolist | grep tsinghua
  tsinghua                         tsinghua
  
  # yum util
  [root@RHEL8-RHCE yum.repos.d]$ yum -y install yum-utils
  tsinghua                     19 kB/s |  11 kB     00:00
  Package yum-utils-4.0.21-14.1.el8.noarch is already installed.
  Dependencies resolved.
  Nothing to do.
  Complete!
  
  # add repo by yum-config-manager
  yum-config-manager --add-repo=<url>
  ```

- Build repo in LAN

  - Next - 通过一个网络服务将repo暴露出去（TODO）

  ```bash
  # sync repo from Internet to Local -> download all rpm from
  reposync --repo <name> -p <localpath>
  
  # install createrepo
  [root@RHEL8-RHCE yum.repos.d]$ yum -y install createrepo
  Last metadata expiration check: 0:19:46 ago on Tue 24 Jan 2023 10:22:23 AM CST.
  Package createrepo_c-0.17.7-6.el8.x86_64 is already installed.
  Dependencies resolved.
  Nothing to do.
  Complete!
  
  # create repo
  createrepo -v <localpath>
  ```

- [Teamviewer](https://www.teamviewer.cn/cn/download/linux/) - 即使`rpm`包不在仓库中，我们也可以通过`yum`安装，而且`yum`可以适用仓库中现有的依赖

  ```bash
  # download
  [root@RHEL8-RHCE Downloads]$ wget https://download.teamviewer.com/download/linux/teamviewer.x86_64.rpm
  [root@RHEL8-RHCE Downloads]$ ll
  total 67176
  -rw-r--r--. 1 root root 68785305 Dec 13 15:23 teamviewer.x86_64.rpm
  
  # install - require epel repo
  [root@RHEL8-RHCE Downloads]$ yum -y install teamviewer.x86_64.rpm
  Installed:
    libXScrnSaver-1.2.3-1.el8.x86_64                                        
    minizip1.2-1.2.11-24.el8.x86_64                                        
    teamviewer-15.37.3-0.x86_64
  
  Complete!
  
  # switch to GUI
  [root@RHEL8-RHCE Downloads]$ systemctl isolate graphical.target
  
  # check history
  yum history
  
  [root@RHEL8-RHCE Downloads]$ yum history info 19
  Transaction ID : 19
  Begin time     : Tue 24 Jan 2023 02:17:19 PM CST
  Begin rpmdb    : 1818:bb5976c423ba8eb331717a8e34120b887b7147ce
  End time       : Tue 24 Jan 2023 02:17:33 PM CST (14 seconds)
  End rpmdb      : 1821:99da696884d0c785b8f9779eb6192030a54a7955
  User           : tutorj <tutorj>
  Return-Code    : Success
  Releasever     : 8
  Command Line   : install teamviewer.x86_64.rpm
  Comment        :
  Packages Altered:
      Install libXScrnSaver-1.2.3-1.el8.x86_64 @AppStream
      Install minizip1.2-1.2.11-24.el8.x86_64  @epel
      Install teamviewer-15.37.3-0.x86_64      @@commandline
  Scriptlet output:
     1 gtk-update-icon-cache: Cache file created successfully.
  
  # undo if installed/deleted by mistake
  [root@RHEL8-RHCE Downloads]$ yum history undo <id>
  ```

- reinstall - if something is missing

  ```bash
  [root@RHEL8-RHCE Downloads]$ yum -y reinstall coreutils
  ```

- update/upgrade

  ```bash
  # update all rpm
  yum update
  # update a specific rpm by version
  yum update traceroute-x.y.z
  
  # upgrade OS
  yum upgrade
  ```

- rpm group

  ```bash
  [root@RHEL8-RHCE Downloads]$ yum group list
  Last metadata expiration check: 0:14:57 ago on Tue 24 Jan 2023 02:24:49 PM CST.
  Available Environment Groups:
     Server
     Minimal Install
     Workstation
     KDE Plasma Workspaces
     Virtualization Host
     Custom Operating System
  Installed Environment Groups:
     Server with GUI
  Installed Groups:
     .NET Core Development
     Container Management
     RPM Development Tools
     Development Tools
     Graphical Administration Tools
     Headless Management
     Smart Card Support
     Scientific Support
     System Tools
     Security Tools
     Legacy UNIX Compatibility
     Network Servers
  Available Groups:
     Fedora Packager
     Xfce
    
  # install/uninstall group
  yum group install <group name>
  yum group uninstall <group name>
  ```

- issue:pensive:

  - 只能单线程安装 - 如果当前yum在安装处于未完成的状态，不能进行另一个安装

### 4. dnf

- `dnf` - **DNF** aka **Dandified YUM** is a next generation Package Manager for **RPM** based Distribution

  ```bash
  # Since RHEL8 - 看上去是在用yum，实际上是dnf
  [root@RHEL8-RHCE Downloads]$ ls -l /bin/yum
  lrwxrwxrwx. 1 root root 5 Jul 19  2022 /bin/yum -> dnf-3
  [root@RHEL8-RHCE Downloads]$ ls -l /bin/dnf-3
  -rwxr-xr-x. 1 root root 1954 Jul 19  2022 /bin/dnf-3
  [root@RHEL8-RHCE Downloads]$ rpm -qf /bin/dnf-3
  python3-dnf-4.7.0-11.el8.noarch
  ```

  ```bash
  # install & enable epel-replease repo
  yum install epel-release
  yum install epel-release –y
  
  # install dnf
  yum install dnf
  
  # dnf version
  dnf --version
  
  # list dnf enabld repo
  dnf repolist
  
  # list dnf all repo
  dnf repolist all
  
  # list all avail from repo & installed pkg
  dnf list
  
  # list installed pkg
  dnf list installed
  
  # list all avail pkg to be installed
  dnf list available
  
  # search pkg
  dnf search <pkg name>
  
  # find the name of the package that provides specific file/sub-package
  dnf provides <file>
  
  # get details of a pkg
  dnf info <pkg name>
  
  # install a pkg
  dnf install <pkg name>
  
  # install a pkg from a repo
  dnf install <pkg name> \
  --enablerepo=epel
  
  # reinstall
  dnf reinstall <pkg name>
  
  # update a pkg
  dnf update <pkg name>
  
  # downgrade a pkg
  dnf downgrade <pkg name>
  
  # check updates for all pkgs installed
  dnf check –update
  
  # update all sys pkgs 
  dnf update
  dnf upgrade
  
  # remove pkg
  dnf remove <pkg name>
  
  # remove orphan pkg (dependencies that are useless to other apps)
  dnf autoremove
  
  # remove cached pkg
  dnf clean all
  
  # help
  dnf help
  dnf help <dnf cmd>
  
  # history
  dnf history
  
  # print all available or installed packages
  dnf grouplist
  
  # install group pkg
  dnf groupinstall '<grp name>'
  
  # update group pkg
  dnf groupupdate '<grp name>'
  
  # remove group pkg
  dnf groupremove '<grp name>'
  
  # sync installed pkg to stable from enabled repo
  dnf distro-sync
  dnf distro-sync <pkg name>
  ```

## 2. Basic Service

### 1. vncserver

```bash
# install
[root@RHEL8-RHCE tutorj]$ yum -y install tigervnc-server

# list all files of package
[root@RHEL8-RHCE tutorj]$ rpm -ql tigervnc
/usr/bin/vncviewer
/usr/lib/.build-id
/usr/lib/.build-id/8c
/usr/lib/.build-id/8c/eb99a5a122df0f58c34bf47349c2e397a45b54
/usr/share/applications/vncviewer.desktop
/usr/share/doc/tigervnc
/usr/share/doc/tigervnc/README.rst
...

# guide
vim /lib/systemd/system/vncserver@.service

# disable firewall & selinux
[root@RHEL8-RHCE tutorj]$ systemctl stop firewalld
[root@RHEL8-RHCE tutorj]$ setenforce 0

# start 
[root@RHEL8-RHCE tutorj]$ vncserver :10

WARNING: vncserver has been replaced by a systemd unit and is now considered deprecated and removed in upstream.
Please read /usr/share/doc/tigervnc/HOWTO.md for more information.
A VNC server is already running as :10

You will require a password to access your desktops.

Password:	# 123456
Verify:
Would you like to enter a view-only password (y/n)? n
A view-only password is not used

New 'RHEL8-RHCE.local:1 (root)' desktop is RHEL8-RHCE.local:1

Creating default startup script /root/.vnc/xstartup
Creating default config /root/.vnc/config
Starting applications specified in /root/.vnc/xstartup
Log file is /root/.vnc/RHEL8-RHCE.local:1.log

# listening on 5910
[root@RHEL8-RHCE tutorj]$ netstat -tunlp | grep 59
tcp        0      0 0.0.0.0:5901            0.0.0.0:*               LISTEN      7335/Xvnc
tcp6       0      0 :::5901                 :::*                    LISTEN      7335/Xvnc

# download VNC Viewer from client 
https://vnc-viewer.en.softonic.com/

# or from linux
[root@RHEL8-RHCE tutorj]$ yum -y install tigervnc

# switch to GUI
systemctl isolate graphical.target

# Connect
TigerVNC Viewer -> localhost:5091
```

### 2. httpd 

```bash
[root@RHEL8-RHCE tutorj]$ yum -y install httpd
Last metadata expiration check: 0:18:31 ago on Tue 24 Jan 2023 07:43:08 PM CST.
Package httpd-2.4.37-51.module+el8.7.0+16050+02173b8e.x86_64 is already installed.
Dependencies resolved.
Nothing to do.
Complete!

[root@RHEL8-RHCE tutorj]$ cd /var/www/html/
[root@RHEL8-RHCE html]$ mv index.html index.html.bak
[root@RHEL8-RHCE html]$ echo test >> index.html

[root@RHEL8-RHCE html]$ systemctl restart httpd
[root@RHEL8-RHCE html]$ systemctl enable httpd
[root@RHEL8-RHCE html]$ curl localhost
test

# why index.html? - config
[root@RHEL8-RHCE html]$ vim /etc/httpd/conf/httpd.conf
#
# DirectoryIndex: sets the file that Apache will serve if a directory
# is requested.
#
<IfModule dir_module>
    DirectoryIndex index.html	# can be changed
</IfModule>

# 当访问web服务器的根的时候
http://localhost
# 回默认检索web服务器根下的默认网页文件，如果没有找到，就不会显示

# DocumentRoot: The directory out of which you will serve your
# documents. By default, all requests are taken from this directory, but
# symbolic links and aliases may be used to point to other locations.
#
DocumentRoot "/var/www/html"	# web服务器的根


# Further relax access to the default document root:
<Directory "/var/www/html">
    #
    # Possible values for the Options directive are "None", "All",
    # or any combination of:
    #   Indexes Includes FollowSymLinks SymLinksifOwnerMatch ExecCGI MultiViews
    #
    # Note that "MultiViews" must be named *explicitly* --- "Options All"
    # doesn't give it to you.
    #
    # The Options directive is both complicated and important.  Please see
    # http://httpd.apache.org/docs/2.4/mod/core.html#options
    # for more information.
    #
    Options Indexes FollowSymLinks	# 如果没有找到默认网页，就会显示服务器根下的所有文件index = FTP

    #
    # AllowOverride controls what directives may be placed in .htaccess files.
    # It can be "All", "None", or any combination of the keywords:
    #   Options FileInfo AuthConfig Limit
    #
    AllowOverride None

    #
    # Controls who can get stuff from this server.
    #
    Require all granted
    # Require all denied
</Directory>
```

### 3. vsftpd

```bash
# ftp - 20/21

# install
[root@RHEL8-RHCE html]$ yum -y install vsftpd
# config
[root@RHEL8-RHCE html]$ vim /etc/vsftpd/vsftpd.conf
# allow anonymous
[root@RHEL8-RHCE html]$ cat /etc/vsftpd/vsftpd.conf | grep anonymous_enable
anonymous_enable=YES
# restart service
[root@RHEL8-RHCE html]$ systemctl restart vsftpd
# listening on port 21
[root@RHEL8-RHCE html]$ netstat -tunlp | grep ftp
tcp6       0      0 :::21                   :::*                    LISTEN      11526/vsftpd
# browser
ftp://localhost
# public folder
[root@RHEL8-RHCE html]$ cd /var/ftp/pub/
```

### 4. tftp

```bash
# UDP - 69
# prod - tftp + dhcp + ftp/http/nfs

# install server
[root@RHEL8-RHCE tutorj]$ yum -y install tftp-server xinetd
[root@RHEL8-RHCE ~]$ rpm -ql tftp-server
/usr/lib/.build-id
/usr/lib/.build-id/f4
/usr/lib/.build-id/f4/2f09672d939b5e358c2d33f21c88cdcf9e2a52
/usr/lib/systemd/system/tftp.service	# service file
/usr/lib/systemd/system/tftp.socket		# socket file
/usr/sbin/in.tftpd
/usr/share/doc/tftp-server
/usr/share/doc/tftp-server/CHANGES
/usr/share/doc/tftp-server/README
/usr/share/doc/tftp-server/README.security
/usr/share/man/man8/in.tftpd.8.gz
/usr/share/man/man8/tftpd.8.gz
/var/lib/tftpboot

# install client
[root@RHEL8-RHCE ~]$ yum -y install tftp
[root@RHEL8-RHCE ~]$ rpm -ql tftp
/usr/bin/tftp
/usr/lib/.build-id
/usr/lib/.build-id/c6
/usr/lib/.build-id/c6/50fa8f63893fbf06df60bc2fd45cc27e0d11a7
/usr/share/doc/tftp
/usr/share/doc/tftp/CHANGES
/usr/share/doc/tftp/README
/usr/share/doc/tftp/README.security
/usr/share/man/man1/tftp.1.gz

# start server
[root@RHEL8-RHCE ~]$ systemctl start tftp
[root@RHEL8-RHCE ~]$ netstat -tunlp | grep :69
udp6       0      0 :::69                   :::*                                1/systemd

# service file
[root@RHEL8-RHCE ~]$ cat /usr/lib/systemd/system/tftp.service
[Unit]
Description=Tftp Server
Requires=tftp.socket
Documentation=man:in.tftpd

[Service]
ExecStart=/usr/sbin/in.tftpd -s /var/lib/tftpboot	# tftp folder
StandardInput=socket

[Install]
Also=tftp.socket

# login
[root@RHEL8-RHCE ~]$ tftp localhost
tftp> help
tftp-hpa 5.2
Commands may be abbreviated.  Commands are:

connect         connect to remote tftp
mode            set file transfer mode
put             send file
get             receive file
quit            exit tftp
verbose         toggle verbose mode
trace           toggle packet tracing
literal         toggle literal mode, ignore ':' in file name
status          show current status
binary          set mode to octet
ascii           set mode to netascii
rexmt           set per-packet transmission timeout
timeout         set total retransmission timeout
?               print help information
help            print help information
```

### 5. dhcpd -> dnsmasq

```bash
# install server
[root@RHEL8-RHCE ~]$ yum install -y dhcp-server

# turn off VM DHCP first

# config template
[root@RHEL8-RHCE ~]$ rpm -ql dhcp-server | grep example
/usr/share/doc/dhcp-server/dhcpd.conf.example
/usr/share/doc/dhcp-server/dhcpd6.conf.example

# copy tempalte & edit
[root@RHEL8-RHCE ~]$ cp /usr/share/doc/dhcp-server/dhcpd.conf.example /etc/dhcp/dhcpd.conf

# A slightly different configuration for an internal subnet.
subnet 1.1.1.0 netmask 255.255.255.0 {
  range 1.1.1.100 1.1.1.200;
  option domain-name-servers 114.114.114.114;
  option routers 1.1.1.1;
  default-lease-time 600;
  max-lease-time 7200;
}

# start servcice
[root@RHEL8-RHCE ~]$ systemctl restart dhcpd
[root@RHEL8-RHCE ~]$ netstat -tunlp | grep :67

# check lease
[root@RHEL8-RHCE ~]$ cat /var/lib/dhcpd/dhcpd.leases
```

## 3. PXE & Kickstart 

### 1. PXE

- 预启动执行环境 - Preboot eXecution Environment

- 提供了一种使用网络接口启动计算机的机制。这种机制让计算机的启动可以不依赖本地数据存储设备（如硬盘）或本地已安装的操作系统

  ```bash
  # 提供远程操作系统安装的服务器A - 两块网卡
  # 一块桥接到物理网络用作管理，可以SSH登录
  # 另一块网卡通过vmware的vmnet10连接，且vmnet10的dhcp关闭，该网卡地址10.1.0/24
  
  # 开启另一台服务器B，该服务器没有操作系统（没有硬盘），且只有一块网卡，该网卡街道vmware的vmnet10上
  # 启动 - BIOS引导 - Network boot from VMWare - 通过vmnet DHCP获取IP
  
  # vmware DHCP limitation
  # ∴在服务器A上部署DHCP服务器
  # 1. 先挂载光盘并配置软件仓库
  mount /dev/sr0 /mnt/
  vim /etc/yum.repos.d/iso.repo
  
  # 2. 安装DHCP server
  yum -y install dhcpd-server
  
  # 3. 编辑配置文件
  cp /usr/share/doc/dhcp-server/dhcpd.conf.example /etc/dhcp/dhcpd.conf
  vim /etc/dhcp/dhcpd.conf
  subnet 10.1.0.0 netmask 255.255.255.0 {
    range 10.1.0.100 10.1.0.200;
  }
  
  # 4. 重启dhcp
  systemctl restart dhcpd
  systemctl enable dhcpd
  netstat -tunlp | grep dhcp
  systemctl stop firewalld
  setenforce 0
  ```

  ```bash
  # 通过PXE启动也需要类似于光盘类似的启动文件
  # 光盘启动时，加载的文件
  [root@RHEL8-RHCE ~]$ mount /dev/sr1 /iso
  
  # 通过这两个来实现操作系统操作
  [root@RHEL8-RHCE isolinux]$ ll | egrep "initrd|vmlinuz"
  -r--r--r--. 2 root root 75530508 Jul  1  2022 initrd.img	# 临时文件系统
  -r-xr-xr-x. 2 root root 10026352 Apr 29  2021 vmlinuz		# Kernel
  
  # 搭建tftp将文件传过去 （见上）
  initrd.img
  vmlinuz
  
  # 服务器A安装syslinux,，引导需要用到
  yum -y install syslinux
  
  # pxelinux.0 under
  /usr/share/syslinux/pxelinux.0
  
  # 将其放入tftp的share根目录
  
  # dhcp配置
  # 服务器B从DHCP获取IP的时候，DHCP会告诉它从tftp服务器上的share根下获取pxelinux.0
  subnet 10.1.0.0 netmask 255.255.255.0 {
    range 10.1.0.100 10.1.0.200;
    next-server 10.1.0.1
    filename "pxelinux.0"
  }
  
  # need ldlinux32，也放到tftp下
  [root@RHEL8-RHCE isolinux]$ ll | grep ld
  -r--r--r--. 1 root root   116064 Nov 13  2020 ldlinux.c32
  
  # 创建pxelinux.cfg
  # 该目录时pxe客户端在执行完pxelinux.0后会自动请求的一个目录，会请求该目录下的boot menu
  mkdir /var/lib/tftpboot/pxelinux.cfg
  
  # 复制现成的到tftp
  cp -rf /usr/share/syslinux/* /var/lib/tftpboot
  
  # edit default
  vim /var/lib/tftpboot/pxelinux.cfg/default
  cat /var/lib/tftpboot/pxelinux.cfg/default
  default menu.c32
  timout 300
  label tutorj
  
  # 再次启动服务器B，进入引导界面
  ```

  ```bash
  # 继续编辑default
  vim /var/lib/tftpboot/pxelinux.cfg/default
  cat /var/lib/tftpboot/pxelinux.cfg/default
  default menu.c32
  timout 300
  label tutorj
    kernel vmlinux           # ++
    append initrd=initrd.img # ++
    
  
  # 搭建http服务器，挂在光盘获取软件包
  mkdir /var/www/html/iso
  mount /dev/sr0 /var/www/html/iso
  systemctl enable httpd --now
  
  curl localhost/iso
  
  # 服务器B
  vmlinux initrd=initrd.img method=http://10.1.0.1/iso
  
  # 继续编辑default
  vim /var/lib/tftpboot/pxelinux.cfg/default
  cat /var/lib/tftpboot/pxelinux.cfg/default
  default menu.c32
  timout 1
  label tutorj
    kernel vmlinux                                      # ++
    append initrd=initrd.img method=http://10.1.0.1/iso # ++
  ```

### 2. Kickstart

- 自动安装操作系统 - 本质是一个配置文件，该配置记录了安装操作系统的步骤

  ```bash
  # config
  /root/anaconda-ks.cfg
  
  # RHEL7 - 自动生成anaconda-ks.cfg
  yum -y install system-config-kickstart
  
  # 添加权限
  chmod o+r *.cfg
  
  # 将cfg放入http服务器的根目录
  cp -a *.cfg /var/www/html
  
  # 继续编辑default
  vim /var/lib/tftpboot/pxelinux.cfg/default
  cat /var/lib/tftpboot/pxelinux.cfg/default
  default menu.c32
  timout 1
  label tutorj
    kernel vmlinux                                                               # ++
    append initrd=initrd.img method=http://10.1.0.1/iso ks=http://10.1.0.1/*.cfg # ++
  ```

## Extra

### 1. subscribe to RHN

### 2. LAMP

- Linux + Apache + MySQL + PHP

### 3. LNMP

- Linux + Nginx + MySQL + PHP

