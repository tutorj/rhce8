[toc]

# 3. Linux User/Group/Password管理

## 1 Linux用戶管理背景和模塊概述

- 增刪改查
  - user 
  - group
  - user password
  - group password
- 用戶管理在Linux中使用的頻率不高
- 雖然Linux支持多用戶管理，但很少有多用戶同時操作一個系統

## 2 用戶的增刪改查和用戶信息配置文件

- `useradd/adduser` - create a new user or update default new user information

  ```bash
  # add a user
  [root@RHEL8-RHCE tutorj]$ useradd test
  
  # -u - speficy uid
  # -d - speficy home directory
  # -s - speficy login shell
  [root@RHEL8-RHCE tutorj]$ useradd test -u 5000 -d /test -s /bin/sh
  [root@RHEL8-RHCE tutorj]$ grep test /etc/passwd
  test:x:5000:5000::/test:/bin/sh
  
  # RHEL系統創建用戶自動創建/home/{user}，對應配置/etc/login.defs
  [root@RHEL8-RHCE tutorj]$ grep CREATE_HOME /etc/login.defs
  CREATE_HOME     yes
  ```

- `userdel` - delete a user account and related files

  ```bash
  # delete a user
  [root@RHEL8-RHCE tutorj]$ userdel test
  [root@RHEL8-RHCE tutorj]$ grep test /etc/passwd
  [root@RHEL8-RHCE tutorj]$ su - test
  su: user test does not exist
  
  # by default, userdel won't delete user home & mail spool
  [root@RHEL8-RHCE tutorj]$ useradd test
  useradd: warning: the home directory already exists.
  Not copying any file from skel directory into it.
  Creating mailbox file: File exists
  [root@RHEL8-RHCE tutorj]$ su - test
  [test@RHEL8-RHCE ~]$
  
  remove home directory and mail spool
  [root@RHEL8-RHCE tutorj]$ userdel -r test
  [root@RHEL8-RHCE tutorj]$ grep test /etc/passwd
  [root@RHEL8-RHCE tutorj]$ ll /home | grep test
  ```

- `usermod` - modify a user account

  ```bash
  # -u - speficy uid
  # -d - speficy home directory
  # -s - speficy login shell
  [root@RHEL8-RHCE tutorj]$ usermod test -u 5001 -d /test1 -s /bin/bash
  [root@RHEL8-RHCE tutorj]$ grep test /etc/passwd
  test:x:5001:5000::/test1:/bin/bash
  ```

- `id` - print real and effective user and group IDs

  - 可以看到uid和gid還有該用戶所屬的所有組
  - gid - primary group
  - 除gid外的所有組都屬於`attached group`

  ```bash
  root@RHEL8-RHCE tutorj]$ id test
  uid=1005(test) gid=1005(test) groups=1005(test)
  
  # primary group - 1005
  # attached group - 6701
  [root@RHEL8-RHCE tutorj]$ id human
  uid=1005(human) gid=1005(human) groups=1005(human),6701(earth)
  ```

- `/tc/passwd`

  ```bash
  # col#1 - username
  # col#2 - password (removed), displayed as x, kept in /etc/shadow
  # col#3 - uid
  # col#4 - gid -> user primary group id
  # col#5 - description
  # col#6 - user home directory
  # col#7 - user login shell
  [root@RHEL8-RHCE tutorj]$ grep test /etc/passwd
  test:x:1005:1005::/home/test:/bin/bash
  ```

## 3 用戶組的增刪改查和用戶信息配置文件

- `groupadd` - create a new group

  ```bash
  # add a group
  [root@RHEL8-RHCE tutorj]$ groupadd test
  
  # -g - specify group id
  [root@RHEL8-RHCE tutorj]$ groupadd -g 10000 test
  [root@RHEL8-RHCE tutorj]$ grep test /etc/group
  test:x:10000:
  ```

- `groupdel` - delete a group

  ```bash
  # delete a group
  [root@RHEL8-RHCE tutorj]$ groupdel test
  [root@RHEL8-RHCE tutorj]$ grep test /etc/group
  [root@RHEL8-RHCE tutorj]$
  ```

- `groupmod` - modify a group definition on the system

  ```bash
  # -g - specify group id
  [root@RHEL8-RHCE tutorj]$ groupmod -g 2233 test
  [root@RHEL8-RHCE tutorj]$ grep test /etc/group
  test:x:2233:
  ```

- `/etc/group`

  ```bash
  # col#1 - group name
  # col#2 - group password, displayed as x -> kept in /etc/gshadows
  # col#3 - group id
  # col#4 - group member
  [root@RHEL8-RHCE tutorj]$ grep test /etc/group
  test:x:6701:
  ```

## 4 用戶的私有組/主要組/附屬組

- `private group`

  - 由於任何用戶必須要依賴於用戶組存在，所以如果**創建用戶沒有指定用戶組**，那麽系統會為該用戶創建一個同名用戶組，即私有組
  - 私有組默認只有一個和該私有組同名的用戶
  - 意義：讓用戶擁有一個用戶組
  - 若其他用戶之後也加入這個組，則該組不是`primary group`

  ```bash
  # group is automatically created
  # gid - 1005 is both private group & primary group for user "test"
  [root@RHEL8-RHCE tutorj]$ useradd test
  [root@RHEL8-RHCE tutorj]$ grep test /etc/passwd
  test:x:1005:1005::/home/test:/bin/bash
  [root@RHEL8-RHCE tutorj]$ grep 1005 /etc/group
  test:x:1005:
  ```

- `primary group`

  - **/etc/passwd col#4**

  ```bash
  # add group when creating user
  # no private group of user - "test"
  # useradd
  # 	-g - speficy primary group
  [root@RHEL8-RHCE tutorj]$ groupadd testgroup -g 2233
  [root@RHEL8-RHCE tutorj]$ grep testgroup /etc/group
  testgroup:x:2233:
  [root@RHEL8-RHCE tutorj]$ useradd test -g testgroup
  [root@RHEL8-RHCE tutorj]$ grep test /etc/passwd
  test:x:1005:2233::/home/test:/bin/bash
  ```

- `attached group`

  - 一個用戶只可以屬於一個`primary group`，但可以屬於多個`attached group`
  - 理論上可以將任何一個用戶組當作一個用戶的`attached group`，但盡可能不要將`private group`作爲某個用戶的`attached group`

  ```bash
  # add user to attached group
  # 1005 is both primary & private group for user "human"
  # useradd
  # 	-G - specify attached group
  [root@RHEL8-RHCE tutorj]$ groupadd earth
  [root@RHEL8-RHCE tutorj]$ useradd human -G earth
  [root@RHEL8-RHCE tutorj]$ grep human /etc/passwd
  human:x:1005:1005::/home/human:/bin/bash
  [root@RHEL8-RHCE tutorj]$ grep 1005 /etc/group
  human:x:1005:
  
  # earth group member has human
  [root@RHEL8-RHCE tutorj]$ grep earth /etc/group
  earth:x:6701:human
  ```

## 5 從用戶組添加/刪除用戶

```bash
# add a user & group
# add a attached group for user
[root@RHEL8-RHCE tutorj]$ useradd test
[root@RHEL8-RHCE tutorj]$ id test
uid=1005(test) gid=1005(test) groups=1005(test)
[root@RHEL8-RHCE tutorj]$ groupadd agroup
[root@RHEL8-RHCE tutorj]$ usermod -G agroup test
[root@RHEL8-RHCE tutorj]$ id test
uid=1005(test) gid=1005(test) groups=1005(test),6701(agroup)

# add another group & add a attached group for user
# agroup has been replaced by agroup1
[root@RHEL8-RHCE tutorj]$ groupadd agroup1
[root@RHEL8-RHCE tutorj]$ usermod -G agroup1 test
[root@RHEL8-RHCE tutorj]$ id test
uid=1005(test) gid=1005(test) groups=1005(test),6702(agroup1)

# -a - append
[root@RHEL8-RHCE tutorj]$ usermod -aG agroup test
uid=1005(test) gid=1005(test) groups=1005(test),6702(agroup1),6701(agroup)
```

- `gpasswd` - administer `/etc/group` and `/etc/gshadow`

  ```bash
  # add attached group for user
  [root@RHEL8-RHCE tutorj]$ id
  uid=0(root) gid=0(root) groups=0(root)
  [root@RHEL8-RHCE tutorj]$ groupadd gpasswd
  [root@RHEL8-RHCE tutorj]$ gpasswd -a test gpasswd
  Adding user test to group gpasswd
  [root@RHEL8-RHCE tutorj]$ id test
  uid=1005(test) gid=1005(test) groups=1005(test),6701(gpasswd)
  
  # remove attached group for user
  [root@RHEL8-RHCE tutorj]$ gpasswd -d test gpasswd
  Removing user test from group gpasswd
  [root@RHEL8-RHCE tutorj]$ id test
  uid=1005(test) gid=1005(test) groups=1005(test)
  ```

## 6 passwd

- `passwd` - update user's authentication tokens

  ```bash
  # set password
  [root@RHEL8-RHCE tutorj]$ useradd test
  [root@RHEL8-RHCE tutorj]$ passwd test
  Changing password for user test.
  New password:
  BAD PASSWORD: The password fails the dictionary check - it does not contain enough DIFFERENT characters
  Retype new password:
  passwd: all authentication tokens updated successfully.
  
  # delete password 
  # -d - delete the password for the named account (root only); also removes password lock if any
  [root@RHEL8-RHCE tutorj]$ passwd -d test
  Removing password for user test.
  passwd: Success
  [root@RHEL8-RHCE tutorj]$ grep test /etc/shadow
  test::19371:0:99999:7:::
  
  # set days info 
  # -e 
  [root@RHEL8-RHCE tutorj]$ passwd -n 3 -x 10 -w 5 -i 2 test
  Adjusting aging data for user test.
  passwd: Success
  [root@RHEL8-RHCE tutorj]$ grep test /etc/shadow
  test::19371:3:10:5:2::
  
  # expire password 
  # -e - expire the password for the named account (root only)
  [root@RHEL8-RHCE tutorj]$ passwd -e test
  Expiring password for user test.
  passwd: Success
  [root@RHEL8-RHCE tutorj]$ grep test /etc/shadow
  test::0:3:10:5:2::
  
  # lock user
  # !! - user is locked, 除了root之外，任何用戶不能切換到locked user
  [root@RHEL8-RHCE tutorj]$ passwd -l test
  Locking password for user test.
  passwd: Success
  [root@RHEL8-RHCE tutorj]$ grep test /etc/shadow
  test:!!:1300:2:20:10:4:20089:
  
  # unlock user
  [root@RHEL8-RHCE tutorj]$ passwd -u -f test
  Unlocking password for user test.
  passwd: Success
  [root@RHEL8-RHCE tutorj]$ grep test /etc/shadow
  test::1300:2:20:10:4:20089:
  
  # passwd accept STDIN 
  [root@RHEL8-RHCE tutorj]$ echo 123 | passwd --stdin test
  Changing password for user test.
  passwd: all authentication tokens updated successfully.
  ```

- `/etc/shadow`

  ```bash
  # col#1 - user
  
  # col#2 - password, encrypted -> /etc/login.defs
  
  # col#3 - 上次修改密碼的時間      - 19372，days since 1970/1/1, passwd cannot modify this value
  
  # col#4 - 密碼最小有效期          - 0 
  # 	0 - 無限次不考慮時間間隔需改密碼
  #   X - 修改完密碼后必須使用密碼X天才能再次修改
  
  # col#5 - 密碼最大有效期          - 99999(default)
  #	X - X天后密碼過期；若想繼續使用，必須在到期前修改
  
  # col#6 - 密碼到期前提前警告天數    - 7
  # 	X - X天前發出警告即將到期
  
  # col#7 - 密碼到期后寬限時間       - null
  #	X - 密碼到期后仍可以使用X天
  
  # col#8 - 密碼失效時間            - null
  
  # col#9 - reserved              - null
  
  [root@RHEL8-RHCE tutorj]$ grep test /etc/shadow
  test:$6$oAim0c4YDy.Ydhi1$zpklZjSWQ/bf8oaBrgCx4huzOF9ZN8NQXsjM9g1/bCB70O6ED20aY2FVzQ1jzWBtrcJiHWnaLCmeIj4BlZAnw0:19371:0:99999:7:::
  
  # password encryption method
  [root@RHEL8-RHCE tutorj]$ grep ENCRYPT /etc/login.defs
  ENCRYPT_METHOD SHA512
  ```

## 7 chage

- `chage` - change user password expiry information

  ```bash
  # -d - set date of last password change to LAST_DAY
  # -m - set minimum number of days before password
  # -M - set maximum number of days before password
  # -W - set expiration warning days to WARN_DAYS
  # -I - set password inactive after expiration
  # -E - set account expiration date to EXPIRE_DATE
  [root@RHEL8-RHCE tutorj]$ chage -d 1300 -m 2 -M 20 -W 10 -I 4 -E 2025-01-01 test
  [root@RHEL8-RHCE tutorj]$ grep test /etc/shadow
  test::1300:2:20:10:4:20089:
  
  # list user password info
  [test@RHEL8-RHCE ~]$ chage -l test
  Last password change                                    : Jan 14, 2023
  Password expires                                        : Feb 03, 2023
  Password inactive                                       : Feb 07, 2023
  Account expires                                         : Jan 01, 2025
  Minimum number of days between password change          : 2
  Maximum number of days between password change          : 20
  Number of days of warning before password expires       : 10
  
  # make password expiree
  [root@RHEL8-RHCE tutorj]$ chage -d 0 test
  [root@RHEL8-RHCE tutorj]$ grep test /etc/shadow
  test:$6$Pzjup5K9WC4Se2dU$0i6NPPOM49UcL/kD8eufehZGcy9qasnFYFehoMFRU9SqXtN/uXqhmlhKDC0/3oP0nPAS0Kqmk7tvP8BV9e2Th0:0:0:99999:7:::
  
  [root@RHEL8-RHCE tutorj]$ su - test
  [test@RHEL8-RHCE ~]$ su - test
  Password:
  You are required to change your password immediately (administrator enforced)
  
  # make password expired
  [test@RHEL8-RHCE ~]$ chage -l test
  Last password change                                    : password must be changed
  Password expires                                        : password must be changed
  Password inactive                                       : password must be changed
  Account expires                                         : never
  Minimum number of days between password change          : 0
  Maximum number of days between password change          : 99999
  Number of days of warning before password expires       : 7
  ```

## 8 理解用戶組密碼的作用

- `gpasswd` - administer /etc/group and /etc/gshadow

  - 作用：讓不屬於該組的用戶，可以切換到改組的一種方式，只要提供正確的組密碼 = 獲得該組的shell

  ```bash
  # set group password
  [root@RHEL8-RHCE tutorj]$ gpasswd test
  Changing the password for group test
  New Password:
  Re-enter new password:
  [root@RHEL8-RHCE tutorj]$ grep test /etc/gshadow
  test:$6$axgaE/0Q3bB$eZpmqBs8KOn7nEA/hdvUUDN6saao73C1uIh2PykvpGA8zBIb5PoDyp4JZRQySg0/IhlfE3qg1Ery5lm2/WKQQ0::
  
  # add user to group
  [root@RHEL8-RHCE tutorj]$ groupadd bgroup
  [root@RHEL8-RHCE tutorj]$ gpasswd -a test bgroup
  Adding user test to group bgroup
  [root@RHEL8-RHCE tutorj]$ id test
  uid=1001(test) gid=1001(test) groups=1001(test),6702(agroup),6703(bgroup)
  
  # remove user from group
  [root@RHEL8-RHCE tutorj]$ gpasswd -d test bgroup
  Removing user test from group bgroup
  [root@RHEL8-RHCE tutorj]$ id test
  uid=1001(test) gid=1001(test) groups=1001(test),6702(agroup)
  ```

- `/etc/gshadow`

  ```bash
  # col#2 - group password, no password by default
  [root@RHEL8-RHCE tutorj]$ grep test /etc/gshadow
  test:!::
  ```

- `newgroup` - log in to a new group, used to change the current group ID during a login session

  ```bash
  # attach a group to a user
  [root@RHEL8-RHCE tutorj]$ id test
  uid=1001(test) gid=1001(test) groups=1001(test)
  [root@RHEL8-RHCE tutorj]$ groupadd agroup
  [root@RHEL8-RHCE tutorj]$ usermod -G agroup test
  [root@RHEL8-RHCE tutorj]$ id test
  uid=1001(test) gid=1001(test) groups=1001(test),6702(agroup)
  
  # into a new shell, group is agroup
  [root@RHEL8-RHCE tutorj]$ su - test
  [test@RHEL8-RHCE ~]$ newgrp agroup
  
  # file group owner belongs to attached group
  [test@RHEL8-RHCE ~]$ ll file
  -rw-r--r--. 1 test agroup 0 Jan 14 09:44 file
  ```

## 9 /etc/login.defs

- 對user/group進行約束，對root無效，優先級低於`/etc/shadows`

    ```bash
    [root@RHEL8-RHCE tutorj]$ grep -v '^#' /etc/login.defs | grep -v '^$'
    # specify mail directory
    MAIL_DIR        /var/spool/mail
    # unmask permission
    UMASK           022
    # home permission
    HOME_MODE       0700
    # password max valid day
    PASS_MAX_DAYS   99999
    # days for password to change
    PASS_MIN_DAYS   0
    # password min length
    PASS_MIN_LEN    5
    # warn days before password expired
    PASS_WARN_AGE   7
    # min UID
    UID_MIN                  1000
    # max UID
    UID_MAX                 60000
    # min system uid
    SYS_UID_MIN               201
    # max system uid
    SYS_UID_MAX               999
    # min group id
    GID_MIN                  1000
    # max group id
    GID_MAX                 60000
    # min system group id
    SYS_GID_MIN               201
    # max system group id
    SYS_GID_MAX               999
    # if create home directory for user
    CREATE_HOME     yes
    # if delete user primary group when deleting user
    USERGROUPS_ENAB yes
    # encryption method
    ENCRYPT_METHOD SHA512
    ```

## 10. Extra

### 10.1 統一認證介紹

- 用戶管理的最終解決方案
- 身份認證服務器 - `Identity Authentication Server`
  - 將服務器本地維護的用戶認證信息交給`IAS`進行托管，管理員只需要維護`IAS`内的信息即可
  - 如果有人想通過usr/pwd訪問服務器時，服務器若本地沒有該用戶的信息，在會訪問`IAS`查看是否有該用戶的信息

### 10.2 使用freeipa搭建統一認證平臺

### ~~10.3 zabbix集成Windows AD實現統一認證~~

