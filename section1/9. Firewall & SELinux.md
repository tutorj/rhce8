[toc]

# Firewall & SELinux

## 1. Firewall

### 1. Overview

- 逻辑划分 - 主机防火墙（针对单个主机防护） & 网络防火墙（针对网络入口和边缘 - 服务于其后的LAN）
- 物理划分 - 硬件（性能成本搞） & 软件（性能成本低）

### 2. Linux Firewall

- Linux本身不具备防火墙功能；
- 话虽如此，但`Kernel`掌控所有的网络流量
- Linux的防火墙功能由`Kernel`中内嵌集成的`netfilter`模块提供

### 3. [iptables](https://wangchujiang.com/linux-command/c/iptables.html)

- 本质是一个客户端，直接和`Kernel`中的`netfilter`进行交互，告诉它流量的放行和阻塞

- 将用户的命令转换成`netfilter`里过滤的`rule`

  

- 内核中流向

  - 进入本机进程（`PREROUTING` -> `INPUT`）
  
  - 转发（PREROUTING -> `FORWARD` -> `POSTROUTING`）
  
  - 本机进程发出（`OUTPUT` -> `POSTROUTING`）
  
    

- Topo

  ```bash
  # 服务器和客户端各两块网卡，管理网卡使用DHCP，应用网卡使用手动配置IP
  # management - 192.168.56.0/24
  nmcli connection add con-name dhcp-mgmt type ethernet ifname enp0s8 ipv4.method auto
  nmcli connection up dhcp-mgmt
  
  # data - 1.1.1.0/24
  nmcli connection add con-name data ifname enp0s9 type ethernet ipv4.addresses 1.1.1.1/24 ipv4.method man
  nmcli connection up data
  
  nmcli connection add con-name data ifname enp0s9 type ethernet ipv4.addresses 1.1.1.2/24 ipv4.method man
  nmcli connection up data
  ```

  

- start

  ```bash
  # stop firewalld 
  [root@RHEL8-RHCE tutorj]$ systemctl stop firewalld
  
  # list default chain - INPUT/FORWARD/OUTPUT - 控制流量的访问控制
  [root@RHEL8-RHCE tutorj]$ iptables -L
  Chain INPUT (policy ACCEPT)
  target     prot opt source               destination
  
  Chain FORWARD (policy ACCEPT)
  target     prot opt source               destination
  
  Chain OUTPUT (policy ACCEPT)
  target     prot opt source               destination
  
  # PREROUTING  for DNAT - 修改目标IP地址
  # POSTROUTING for SNAT - 修改源IP地址
  [root@RHEL8-RHCE tutorj]$ iptables -L -t nat
  Chain PREROUTING (policy ACCEPT)
  target     prot opt source               destination
  
  Chain INPUT (policy ACCEPT)
  target     prot opt source               destination
  
  Chain POSTROUTING (policy ACCEPT)
  target     prot opt source               destination
  
  Chain OUTPUT (policy ACCEPT)
  target     prot opt source               destination
  
  # BE CAREFUL！
  iptables -F  # 清空所有的防火墙规则
  iptables -X  # 删除用户自定义的空链
  iptables -Z  # 清空计数
  ```

  ```bash
  # 拒绝1.1.1.0/24网段的主机访问ssh
  # -A      - append to chain
  # -s      - source
  # -p      - protocl
  # --dport - dst port
  # -j      - action
  # -n      - no resolution
  [root@RHEL8-RHCE tutorj]$ iptables -A INPUT -s 1.1.1.0/24 -p tcp --dport 22 -j REJECT
  [root@RHEL8-RHCE tutorj]$ iptables -L -n
  Chain INPUT (policy ACCEPT)
  target     prot opt source               destination
  REJECT     tcp  --  1.1.1.0/24           anywhere             tcp dpt:22 reject-with icmp-port-unreachable
  
  # ssh from client is rejected 
  [root@RHEL8-RHCE tutorj]$ ssh root@1.1.1.1
  ssh: connect to host 1.1.1.1 port 22: Connection refused
  
  # delete rule by number
  [root@RHEL8-RHCE tutorj]$ iptables -D INPUT 1
  ```

  ```bash
  # default rule
  iptables -P INPUT DROP    # 配置默认的不让进
  iptables -P FORWARD DROP  # 默认的不允许转发
  iptables -P OUTPUT ACCEPT # 默认的可以出去
  ```



- blacklist - 默认放行所有，把想拒绝的规则吸入

- whitelist - 默认拒绝所有，把想放行的规则写入 - Better:grinning:

  

- 一般`iptables`不对OUTPUT & FOWARD流量进行控制

  - 一般服务器的操作系统不会开启流量转发
  - 这些流量没必要进行限制

  

### 4. firewalld

- Since RHEL7/Fedora20/Centos7

- A service provides firewall configuration - 通过firewalld服务提供更加便捷的工具来配置防火墙，原理基于`iptables`

  - `zone` - firewallld将系统划分成多个zone
    - 如果一个网卡属于的某一个`zone`，那么`zone`里的所有`rule`都会应用到网卡上
    - 默认所有的网卡都在默认的zone中，但如果有些网卡不受`Kernel`管理，`rule`也无法生效
    - ==三要素：zone + rule + 网卡==

  
  
- zone & NIC
  
  ```bash
  # list all zones - 一般只要不适特别复杂的网络场景，一个zone就可以解决所有问题
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-all-zones | grep -B 1 'target'
  block
    target: %%REJECT%%
  --
  dmz
    target: default
  --
  drop
    target: DROP
  --
  external
    target: default
  --
  home
    target: default
  --
  internal
    target: default
  --
  libvirt
    target: ACCEPT
  --
  nm-shared
    target: ACCEPT
  --
  public (active)
    target: default
  --
  servers
    target: default
  --
  trusted
    target: ACCEPT
  --
  work
    target: default
  
  # list default zone
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-all
  public (active)
    target: default
    icmp-block-inversion: no
    interfaces: enp0s3 enp0s8 enp0s9
    sources:
    services: cockpit dhcpv6-client http ssh
    ports:
    protocols:
    forward: no
    masquerade: no
    forward-ports:
    source-ports:
    icmp-blocks:
    rich rules:
  
  # list specifc zone
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-all --zone=home
  home
    target: default
    icmp-block-inversion: no
    interfaces:
    sources:
    services: cockpit dhcpv6-client mdns samba-client ssh
    ports:
    protocols:
    forward: no
    masquerade: no
    forward-ports:
    source-ports:
    icmp-blocks:
    rich rules:
  
  # check & set default zone
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --get-default-zone
  public
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --set-default-zone=<zone>
  
  
  # list interfaces in default zone
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-interfaces
  enp0s3 enp0s8 enp0s9
  
  # add/remove interface
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --remove-interface=enp0s9
  success
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-interfaces
  enp0s3 enp0s8
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --add-interface=enp0s9
  success
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-interfaces
  enp0s3 enp0s8 enp0s9
  ```
  
- rule - service/port/rich

  ```bash
  # list default zone - rule inside
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-all
  public (active)						# 只有包含网卡，zone才会active
    target: default
    icmp-block-inversion: no
    interfaces: enp0s3 enp0s8 enp0s9	# 只有包含网卡，zone才会active
    sources:
    services: cockpit dhcpv6-client http ssh
    ports:
    protocols:
    forward: no
    masquerade: no
    forward-ports:
    source-ports:
    icmp-blocks:
    rich rules:
  
  # add/remove service
  # 这里的service仅仅只是一个名字指代，至于service到底放行了说明，要看该service的端口号
  # 如果要放行的端口并没有在service规则中xml文件里定义，那就不能用service规则来满足你的条件
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --add-service=ftp
  success
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-services
  cockpit dhcpv6-client ftp http ssh
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --remove-service=ftp
  success
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-services
  cockpit dhcpv6-client http ssh
  
  # add/remove port
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --add-port=2233/tcp
  success
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-ports
  2233/tcp
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --remove-port=2233/tcp
  success
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-ports
  
  # add/remove rich rule ≈ iptables
  # 可以现在模拟环境中通过GUI生成
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --add-rich-rule="rule family=ipv4 source address=2.2.2.0/24 port port=8089 protocol=tcp reject"
  success
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-rich-rules
  rule family="ipv4" source address="2.2.2.0/24" port port="8089" protocol="tcp" reject
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --remove-rich-rule="rule family=ipv4 source address=2.2.2.0/24 port port=8089 protocol=tcp reject"
  success
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --list-rich-rules
  
  # rich rule manual
  [root@RHEL8-RHCE tutorj]$ man firewalld.richlanguage
  
  # save rules to permanent - 不会立刻生效
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --runtime-to-permanent
  success
  # reload - temp rule will be lost
  [root@RHEL8-RHCE tutorj]$ firewall-cmd --reload
  success
  ```

- port-forwarding = DNAT -> PREROUTING

  - 路由器分割内外网，内网web服务器使用私有地址
  - 外部想要访问内部web服务器，首先命中路由器，这里要进行DNAT，将目标地址修改为内网的web服务器私有地址

  ```bash
  firewall-cmd --add-forward-port=port=port-number:proto=tcp|udp|sctp|dccp:toport=port-number:toaddr=IP
  ```

## 2. SELinux



### 1. Overview

- Security Enhanced Linux -> integrated in `Kernel` since REHL4

  

- Before SELinux - `DAC` - Discretionary Access Control - 自主访问控制

  - 传统Linux安全模式基于 - ownership & ACL
  - 主体（process）的权限（capability）决定了它能访问和操作说明
  - 只要进程有root权限，该进程就能在系统上做任何事 - 风险:pensive:

- After  SELinux - `MAC` - Mandatory     Access Control - 强制访问控制 -> ==限制进程权限 via label==

  - 系统的policy决定了主体（process）能操作访问哪些客体

  - 即使是root进程，系统policy配置了什么，我们才能做什么

  - 该模式下，root进程和普通进程无区别对待

    

    <img src="http://2.bp.blogspot.com/-f9bsLR0_DOs/VCGqHx4bBtI/AAAAAAAAAjA/gi8Qho7cezs/s1600/DAC%2Bvs%2BMAC%2Bvs%2BRBAC.jpg" alt="Cloud Audit Controls: MAC vs DAC vs RBAC" style="zoom:50%;" />

    

  - [Coloring Book](https://developers.redhat.com/download-manager/file/SELinuxColoringBook.pdf)

    - ==标记==狗粮 & 猫粮；狗只能吃狗粮；猫只能吃猫粮；狗不能吃猫粮；猫不能吃狗粮

### 2. Context

```bash
[root@RHEL8-RHCE[root@RHEL8-RHCE tutorj]$ ps aux | grep httpd
root        1541  0.0  0.5 258112 10848 ?        Ss   19:38   0:00 /usr/sbin/httpd -DFOREGROUND
apache      1696  0.0  0.4 274092  8312 ?        S    19:38   0:00 /usr/sbin/httpd -DFOREGROUND

# -Z - show SElinux context
[root@RHEL8-RHCE tutorj]$ ps auxZ | grep httpd
system_u:system_r:httpd_t:s0    root        1541  0.0  0.5 258112 10848 ?        Ss   19:38   0:00 /usr/sbin/httpd -DFOREGROUND
system_u:system_r:httpd_t:s0    apache      1696  0.0  0.4 274092  8312 ?        S    19:38   0:00 /usr/sbin/httpd -DFOREGROUND

[root@RHEL8-RHCE tutorj]$ ll
total 0
drwxr-xr-x. 2 tutorj tutorj 18 Jan 12 21:29 Desktop
drwxr-xr-x. 2 tutorj tutorj 64 Dec 25 19:42 Documents
drwxr-xr-x. 2 tutorj tutorj  6 Dec 14 23:02 Downloads

# -Z - show SElinux context
# drwxr-xr-x. -> . 说明有什么SELinux context
[root@RHEL8-RHCE tutorj]$ ll -Z
total 0
drwxr-xr-x. 2 tutorj tutorj unconfined_u:object_r:user_home_t:s0  18 Jan 12 21:29 Desktop
drwxr-xr-x. 2 tutorj tutorj unconfined_u:object_r:user_home_t:s0  64 Dec 25 19:42 Documents
drwxr-xr-x. 2 tutorj tutorj unconfined_u:object_r:user_home_t:s0   6 Dec 14 23:02 Downloads

# semanage
# 如果考试没有需要安装的~
[root@RHEL8-RHCE web]$ which semanage
/sbin/semanage
[root@RHEL8-RHCE web]$ rpm -qf /sbin/semanage
policycoreutils-python-utils-2.9-20.el8.noarch

# list full selinux context
[root@RHEL8-RHCE tutorj]$ semanage fcontext -l | grep user_home_t
/home/[^/]+/.+                                     all files          unconfined_u:object_r:user_home_t:s0

# more options
[root@RHEL8-RHCE tutorj]$ semanage
boolean     dontaudit   export      fcontext    import      interface   login       
module      node        permissive  port        user
```

```bash
[root@RHEL8-RHCE tutorj]$ mkdir /web
[root@RHEL8-RHCE tutorj]$ cd /web
[root@RHEL8-RHCE web]$ touch qwe
[root@RHEL8-RHCE web]$ ll -Z
total 0
-rw-r--r--. 1 root root unconfined_u:object_r:default_t:s0 0 Jan 26 20:35 qwe

# add context
[root@RHEL8-RHCE web]$ semanage fcontext -a -t httpd_sys_content_t '/web(/.*)?'
[root@RHEL8-RHCE web]$ semanage fcontext -l | grep "^/web"
/web(/.*)?                                         all files          system_u:object_r:httpd_sys_content_t:s0
[root@RHEL8-RHCE web]$ touch test1
[root@RHEL8-RHCE web]$ ll -Z
total 0
-rw-r--r--. 1 root root unconfined_u:object_r:default_t:s0 0 Jan 26 20:35 qwe
-rw-r--r--. 1 root root unconfined_u:object_r:default_t:s0 0 Jan 26 20:39 test1

# restore file(s) default SELinux security contexts
# make effective/permanently
# -R - recursively
# 
[root@RHEL8-RHCE web]$ restorecon -Rv .
Relabeled /web from unconfined_u:object_r:default_t:s0 to unconfined_u:object_r:httpd_sys_content_t:s0
Relabeled /web/qwe from unconfined_u:object_r:default_t:s0 to unconfined_u:object_r:httpd_sys_content_t:s0
Relabeled /web/test1 from unconfined_u:object_r:default_t:s0 to unconfined_u:object_r:httpd_sys_content_t:s0

# context changed
[root@RHEL8-RHCE web]$ ll -Z
total 0
-rw-r--r--. 1 root root unconfined_u:object_r:httpd_sys_content_t:s0 0 Jan 26 20:35 qwe
-rw-r--r--. 1 root root unconfined_u:object_r:httpd_sys_content_t:s0 0 Jan 26 20:39 test1
-rw-r--r--. 1 root root unconfined_u:object_r:httpd_sys_content_t:s0 0 Jan 26 20:40 test2
```

```bash
[root@RHEL8-RHCE tutorj]$ semanage port -l | grep http
http_cache_port_t              tcp      8080, 8118, 8123, 10001-10010
http_cache_port_t              udp      3130
http_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, 9000
pegasus_http_port_t            tcp      5988
pegasus_https_port_t           tcp      5989
[root@RHEL8-RHCE tutorj]$ semanage port -l | grep ssh
ssh_port_t                     tcp      22

# change port to 8090 but failed
[root@RHEL8-RHCE tutorj]$ grep 8090 /etc/httpd/conf/httpd.conf
Listen 8090
[root@RHEL8-RHCE tutorj]$ systemctl restart httpd
Job for httpd.service failed because the control process exited with error code.
See "systemctl status httpd.service" and "journalctl -xe" for details.

# check system log
[root@RHEL8-RHCE tutorj]$ journalctl -xe
Jan 27 08:43:44 RHEL8-RHCE.local httpd[5153]: (13)Permission denied: AH00072: make_sock: could not bind to address [::]:8090
Jan 27 08:43:44 RHEL8-RHCE.local httpd[5153]: (13)Permission denied: AH00072: make_sock: could not bind to address 0.0.0.0:8090

# add http_port_t label to port 8090
[root@RHEL8-RHCE tutorj]$ semanage port -a -t http_port_t -p tcp 8090
[root@RHEL8-RHCE tutorj]$ semanage port -l | grep 8090
http_port_t                    tcp      8090, 80, 81, 443, 488, 8008, 8009, 8443, 9000
[root@RHEL8-RHCE tutorj]$ systemctl restart httpd
[root@RHEL8-RHCE tutorj]$ systemctl status httpd
● httpd.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled)
   Active: active (running) since Fri 2023-01-27 08:48:37 CST; 5s ago
```

```bash
# temp switch
[root@RHEL8-RHCE tutorj]$ getenforce
Enforcing
[root@RHEL8-RHCE tutorj]$ setenforce 0
[root@RHEL8-RHCE tutorj]$ getenforce
Permissive
[root@RHEL8-RHCE tutorj]$ setenforce 1
[root@RHEL8-RHCE tutorj]$ getenforce
Enforcing

# log
[root@RHEL8-RHCE tutorj]$ vim /var/log/audit/audit.log


# permanent - reboot to make effective
[root@RHEL8-RHCE tutorj]$ cat /etc/selinux/config

# This file controls the state of SELinux on the system.
# SELINUX= can take one of these three values:
#     enforcing - SELinux security policy is enforced.
#     permissive - SELinux prints warnings instead of enforcing.
#     disabled - No SELinux policy is loaded.
SELINUX=enforcing
# SELINUXTYPE= can take one of these three values:
#     targeted - Targeted processes are protected,
#     minimum - Modification of targeted policy. Only selected processes are protected.
#     mls - Multi Level Security protection.
SELINUXTYPE=targeted
```

```bash
# bool针对服务的开关设置 - basically all off
[root@RHEL8-RHCE tutorj]$ semanage boolean -l | grep ssh
fenced_can_ssh                 (off  ,  off)  Allow fenced to can ssh
selinuxuser_use_ssh_chroot     (off  ,  off)  Allow selinuxuser to use ssh chroot
ssh_chroot_rw_homedirs         (off  ,  off)  Allow ssh to chroot rw homedirs
ssh_keysign                    (off  ,  off)  Allow ssh to keysign
ssh_sysadm_login               (off  ,  off)  Allow ssh to sysadm login
ssh_use_tcpd                   (off  ,  off)  Allow ssh to use tcpd

# set
[root@RHEL8-RHCE tutorj]$ setsebool -P ssh_sysadm_login on
[root@RHEL8-RHCE tutorj]$ semanage boolean -l | grep ssh_sysadm_login
ssh_sysadm_login               (on   ,   on)  Allow ssh to sysadm login
[root@RHEL8-RHCE tutorj]$ setsebool -P ssh_sysadm_login off
[root@RHEL8-RHCE tutorj]$ semanage boolean -l | grep ssh_sysadm_login
ssh_sysadm_login               (off  ,  off)  Allow ssh to sysadm login
```

## Extra

### 1. SNAT

### 2. DNAT