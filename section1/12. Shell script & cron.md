[toc]

# Shell script & cron

## 1. Shell script

### 1. overview

-  Shell script is a script language -> executable <- intepretor to execute

  **当我们在执行`ls`指令的时候，就是当前的`Shell`将`ls`转换成`Kernel`能理解的语言指令最终执行**

  - `bash` - default in Linux

  - `sh`   - default in Unix

    ```bash
    # show current shell
    [root@host-1 ~]# echo $SHELL
    /bin/bash
    
    # list supported shell
    [root@host-1 ~]# cat /etc/shells
    /bin/sh
    /bin/bash
    /usr/bin/sh
    /usr/bin/bash
    /bin/ksh
    /bin/rksh
    /bin/tcsh
    /bin/csh
    
    # #！- 约定标记，告诉系统使用什么解释器去执行该脚本
    #!/bin/bash
    ...
    
    # exexute
    chmod +x *.sh
    ./*.sh
    # 如果指定了解释器，那么会忽略脚本中的
    /bin/bash ./*.sh
    ```

### 2. variable

- 用户自定义变量
- 特殊变量
- 环境变量

### 3. if

### 4. 

## 2. cron

- a job that is `planeed/scheduled` & `automatically` executed - 自动按计划执行的任务

### 1. one-off

- 按计划==只执行一次==的任务

- `at` -  executes commands at a specified time - `atd`后台进程

  ```bash
  
  ```

	# turn off ntp sync
  timedatctl set-ntp 0

  # set system time
  date -s "yyyy-mm-dd HH:MM:SS"

  # set at job -> interactive -> Ctrl + d to submit
  at 5:00PM
  at > /root/backup-yum-repo.sh
  at > EOF

  at 6:22
  at > /root/backup-yum-repo.sh
  at > EOF

  at 2023-12-07
  at > /root/backup-yum-repo.sh
  at > EOF

  at 12:00 2023-12-07
  at > /root/backup-yum-repo.sh
  at > EOF

  at 12:00 + 5 days
  at > /root/backup-yum-repo.sh
  at > EOF

  at midnight/noon/teatime
  at > /root/backup-yum-repo.sh
  at > EOF

  at monday
  at > /root/backup-yum-repo.sh
  at > EOF
  ```
  
  ```bash
	# lists the user's pending jobs, unless the user is the superuser; 
  # in that case, everybody's jobs are listed.
  atq
  
  # remove job by id
  atrm <id>
  
  # cats the jobs listed on the command line to standard output
  at -c <id
  ```

	```bash
	# 可能同时有多个用户在使用at，可以启用和禁用用户使用
	# 当同时使用的时候，白名单优先
	
	# 白名单 -> 推荐；RHEL8默认没有
	/etc/at.allow
	# 黑名单
	/etc/at.deny
	```

### 2. periodic

- `crontab` - maintain crontab files for individual users - `crond`后台进程

  ```bash
  # list crontab of specified user
  crontab -l
  
  # ppends the name of the user whose crontab is to be modified
  crontab -e -u tutorj
  
  # Edits the current crontab using the editor
  crontab -e
  
  # Appends the name of the user whose crontab is to be modified
  crontab -e -u tutorj
  ```

- [format](https://crontab.guru/)

  ```bash
  # 顺序：分 时 日 月 周
  Example of job definition:
  .---------------- minute (0 - 59)
  |  .------------- hour (0 - 23)
  |  |  .---------- day of month (1 - 31)
  |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
  |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
  |  |  |  |  |
  *  *  *  *  * user-name  command to be executed
  ```

- example

  ```bash
  # 每1分钟执行一次command
  * * * * * command
  
  # 每小时的第3和第15分钟执行
  3,15 * * * * command
  
  # 在上午8点到11点的第3和第15分钟执行
  3,15 8-11 * * * command
  
  # 每隔两天的上午8点到11点的第3和第15分钟执行
  3,15 8-11 */2 * * command
  
  # 每个星期一的上午8点到11点的第3和第15分钟执行
  3,15 8-11 * * 1 command
  
  # 每晚的21:30重启smb 
  30 21 * * * /etc/init.d/smb 
  
  # 每月1、10、22日的4 : 45重启smb 
  45 4 1,10,22 * * /etc/init.d/smb restart
  
  # 每周六、周日的1:10重启smb
  10 1 * * 6,0 /etc/init.d/smb restart
  
  # 每天18 : 00至23 : 00之间每隔30分钟重启smb 
  0,30 18-23 * * * /etc/init.d/smb restart
  
  # 每星期六的晚上11:00 pm重启smb 
  0 23 * * 6 /etc/init.d/smb restart
  
  # 每一小时重启smb 
  * */1 * * * /etc/init.d/smb restart
  
  # 晚上11点到早上7点之间，每隔一小时重启smb
  * 23-7/1 * * * /etc/init.d/smb restart
  
  # 每月的4号与每周一到周三的11点重启smb 
  0 11 4 * mon-wed /etc/init.d/smb restart
  
  # 一月一号的4点重启smb
  0 4 1 jan * /etc/init.d/smb restart
  
  # 每小时执行/etc/cron.hourly目录内的脚本
  01 * * * * root run-parts /etc/cron.hourly
  ```

- config

  ```bash
  # 可以在一个文件中配置多个用户的crontab
  /etc/crontab
  ```

- control

  ```bash
  # 同at，也具备白名单/黑名单
  [root@host-1 cron.d]# cat /etc/cron.allow
  actadm
  casadm
  syncuser
  zooadm
  ```

- second-level precision

  ```bash
  # 每1分钟5s后执行一次command
  * * * * * sleep 5; command
  * * * * * sleep 10; command
  * * * * * sleep 15; command
  * * * * * sleep 20; command
  ...
  ```

- log

  ```bash
  /var/log/cron
  ```

