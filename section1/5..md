[toc]

# 5. Linux進程/服務管理

## 1. Overview

- ==進程== - 通俗來説，就是正在執行的程序or指令
  - 每一個進程都是一個運行實體，占用一定的系統資源 - CPU & Mem （+ Network & Disk）
- 進程管理的作用
  1. 判斷服務器的健康狀態
  2. 查看系統中的所有進程
  3. “殺死”進程

## 2. ps

- `ps` - report a snapshot of the current processes

  ```bash
  # BSD format
  # a - list all processes with a terminal (tty)，or to list all processes when used together with the x option.
  # u - show process run by which user
  # x - list all processes owned by you (same EUID as ps), or to list all processes when used together with the a option.
  ps aux
  
  # USER    - 该进程是由哪个⽤户产⽣的
  # PID     - 进程的ID号
  
  # %CPU    - 该进程占⽤CPU资源的百分⽐
  # %MEM    - 该进程占⽤物理内存的百分⽐
  
  # VSZ     - （運維care）该进程占⽤虚拟内存的，单位KB（Disk中的一部分當作Mem使用 - SWAP）
  # RSS     - （開發care）该进程占⽤物理内存的，单位KB                               
  
  # TTY     - 進程的運行終端
  # 	TTY1-TTY6代表本地控制台终端，TTY1是GUI，TTY2-6是本地的CLI
  # 	PTS/0-255代表虚拟终端，比如ssh；
  #   如果是“？”，则表示该进程是由内核直接产⽣，⽽不是任何的终端产⽣
  
  # STAT    - 进程状态
  #	R - Running    (CPU & Mem keeps changing)
  #	S - Sleeping   (CPU & Mem stay still) - 程序可能進入中斷或者出現問題 or CPU不足，等待其他占用釋放
  #	T - Terminated 
  #   Z - Zombie      脫離了系統的管理，無法被殺死，會一直占用資源
  #	s - subprocess
  #	+ - daemon
  
  # START   - 该进程的启动时间
  # TIME    - 该进程占⽤CPU的运算时间
  
  # COMMAND - 产⽣此进程的命令
  [tutorj@RHEL8-RHCE ~]$ cat
  [root@RHEL8-RHCE tutorj]# ps aux | grep cat
  USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
  tutorj      8382  0.0  0.0   7460   952 pts/1    S+   20:38   0:00 cat
  
  # 不斷輸出0 - %CPU increased
  [tutorj@RHEL8-RHCE ~]$ cat /dev/zero
  [root@RHEL8-RHCE tutorj]# ps aux | grep cat
  USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
  tutorj      8625  7.4  0.1   7460  1920 pts/1    S+   20:50   0:00 cat /dev/zero
  
  # 不斷從/dev/zero下產生文件到/dev/null中 - %Mem increased
  [tutorj@RHEL8-RHCE ~]$ dd if=/dev/zero of=/dev/null bs=100MB
  [root@RHEL8-RHCE tutorj]# ps aux | grep zero
  USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
  tutorj      9236 95.7  5.3 105032 99340 pts/1    R+   20:58   0:16 dd if=/dev/zero of=/dev/null bs=100MB
  
  # cat from local terminal，TTY is tty1 not pts
  [tutorj@RHEL8-RHCE ~]$ cat
  [root@RHEL8-RHCE tutorj]# ps aux | grep cat
  USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
  tutorj      9693  0.0  0.0   7460   864 tty1     S+   21:06   0:00 cat
  
  # STAT:Ss - crond has subprocess（es）
  [root@RHEL8-RHCE tutorj]# ps aux | grep gdm
  USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
  root        1498  0.0  0.1  25864  3140 ?        Ss   19:14   0:00 /usr/sbin/crond -n
  ```

## 3. top

- `top` - display Linux processes (dynamically)

  ```bash
  # set intenval
  top -d <second>
  
  # exit
  q
  
  # Sort by CPU
  P
  
  # Sort by Mem
  M
  
  # Sort byu PID
  N
  ```

  ```bash
  # row#1. uptime, users logged in, load average in 1/5/15min
  top - 04:23:47 up 20 days, 22:34,  2 users,  load average: 1.46, 1.56, 1.46
  
  # row#2. total threads
  Tasks: 227 total,   1 running, 226 sleeping,   0 stopped,   0 zombie
  
  # row#3. CPU state percentages
  # us, user    : time running un-niced user processes
  # sy, system  : time running kernel processes
  # ni, nice    : time running niced user processes
  # id, idle    : time spent in the kernel idle handler
  # wa, IO-wait : time waiting for I/O completion
  # hi          : time spent servicing hardware interrupts
  # si          : time spent servicing software interrupts
  # st          : time stolen from this vm by the hypervisor
  %Cpu(s): 17.7 us, 11.5 sy,  0.0 ni, 70.3 id,  0.0 wa,  0.0 hi,  0.4 si,  0.0 st
  
  # row#4. Memory Usage
  # Pysical
  KiB Mem : 30715236 total,   367120 free, 23598248 used,  6749868 buff/cache
  # Virtual
  KiB Swap:  6143996 total,  6031612 free,   112384 used.  5072552 avail Mem
  
  # Fields
  # PID      Process ID 
  # USER     Process Owner
  # PR       Scheduling Priority of Process
  # NI       Nice Value of Process, negative = higher
  # VIRT     Virtual Memory Size
  # RES      Resident Memory Size
  # SHR      Shared Memory Size
  # S        Process Status
  # %CPU     Process share of the elapsed CPU time since the last screen update
  # %MEM     A process's currently used share of available physical memory
  # TIME+    Total  CPU  time  the task has used since it started
  # COMMAND  Process cmd
  # PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
  2475 puppet    20   0 7267860   2.1g  17420 S  61.8  7.2  11496:13 java
  ```

### 1. system load & CPU core

### 2. Mem

## 4. pstree

- `pstree` - display a tree of processes - 能直觀看到父子進程的派生關係

  ```bash
  # -p - show pid -> expand tree
  [root@RHEL8-RHCE tutorj]# pstree
  systemd─┬─ModemManager───2*[{ModemManager}]
          ├─NetworkManager───2*[{NetworkManager}]
          ├─VBoxDRMClient───3*[{VBoxDRMClient}]
          ├─VBoxService───8*[{VBoxService}]
          ├─3*[abrt-dump-journ]
          ├─abrtd───2*[{abrtd}]
          ├─alsactl
          ├─atd
          ├─auditd─┬─sedispatch
          │        └─2*[{auditd}]
          ├─avahi-daemon───avahi-daemon
          ├─chronyd
          ├─crond
          ├─cupsd
          ├─3*[dbus-daemon───{dbus-daemon}]
          ├─2*[dbus-kill-proce───gio───2*[{gio}]]
          ├─dnsmasq───dnsmasq
          ├─firewalld───{firewalld}
          ├─gssproxy───5*[{gssproxy}]
          ├─2*[gvfsd───2*[{gvfsd}]]
          ├─gvfsd-fuse───5*[{gvfsd-fuse}]
          ├─ksmtuned───sleep
          ├─login───bash
          ├─lsmd
          ├─mcelog
          ├─packagekitd───2*[{packagekitd}]
          ├─pmcd───pmdaroot─┬─pmdadm
          │                 ├─pmdakvm
          │                 ├─pmdalinux
          │                 ├─pmdaproc
          │                 ├─pmdaxfs
          │                 └─2*[python3]
          ├─pmie
          ├─pmlogger
          ├─2*[pmpause]
          ├─polkitd───5*[{polkitd}]
          ├─rhsmcertd
          ├─rpcbind
          ├─rsyslogd───2*[{rsyslogd}]
          ├─rtkit-daemon───2*[{rtkit-daemon}]
          ├─smartd
          ├─sshd─┬─sshd───sshd───bash───sudo───bash───pstree
          │      ├─2*[sshd───sshd───sftp-server]
          │      └─sshd───sshd───bash
          ├─sssd─┬─sssd_be
          │      └─sssd_nss
          ├─stratisd───4*[{stratisd}]
          ├─systemd─┬─(sd-pam)
          │         ├─dbus-daemon───{dbus-daemon}
          │         └─pulseaudio───2*[{pulseaudio}]
          ├─systemd-journal
          ├─systemd-logind
          ├─systemd-machine
          ├─systemd-udevd
          └─tuned───4*[{tuned}]
          
  [root@RHEL8-RHCE tutorj]# pstree -p | grep bash
             |-login(1513)---bash(9620)
             |-sshd(1200)-+-sshd(4394)---sshd(4413)---bash(4420)---sudo(5857)---bash(5861)-+-grep(11261)
             |            |-sshd(8258)---sshd(8263)---bash(8265)
  ```

## 5. kill

- `kill` - terminate a process

  ```bash
  
  ```

## 6. Normal vs Daemon Process

## 7. Scheduling

## Extra

