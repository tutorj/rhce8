[toc]

# 4. Linux權限管理

## 1. 權限

- `file`

  - col#1-3 - permission of **owner** (user)

    - **文件的擁有者可以隨意更改這個文件的權限**

  - col#4-6 - permission of **group**

  - col#7-9 - permission of **others** (neither user nor group)

    

  - 一般來説，權限：owner > group > others

  - 文件的owner不一定屬於文件的所屬組

    

  - permission

    - `r(4)` - read    - 文件内容可以被查看

    - `w(2)` - write   - 文件可以被修改（增刪改）

    - `x(1)` - execute - 文件可以當作脚本運行

    - `-(0)` - none    - null

      

- `directory`

  - permission

    - `r(4)` - read    - 該目錄下的文件可以被查看屬性 - `ls`

      - ==文件是否能夠查看與所在目錄沒有任何關係，與文件是否具有r權限==

    - `w(2)` - write   - 可以在該目錄下創建/刪除/修改文件（屬性）

      - ==文件是否被修改與所在目錄沒有任何關係，與文件是否具有w權限==

    - `x(1)` - execute - 可以進入該目錄 = key to entry

      - ==若目錄無x屬性，仍然可以在該目錄下創建/刪除/查看文件，可以通過絕對路徑的方式:)==

    - `-(0)` - none    - null

      

  - 對於`directory`而言，只有3類權限有意義

    - `---` - 沒有任何權限
    - `r-x` - 有讀權限
    - `rwx` - 有讀寫權限

## 2. chown/chmod

- `chown/chgrp` - change file owner and group

  ```bash
  [root@RHEL8-RHCE tutorj]$ useradd user1
  [root@RHEL8-RHCE tutorj]$ useradd user2
  [root@RHEL8-RHCE tutorj]$ id user1
  uid=1001(user1) gid=1001(user1) groups=1001(user1)
  [root@RHEL8-RHCE tutorj]$ id user2
  uid=1002(user2) gid=6702(user2) groups=6702(user2)
  
  [root@RHEL8-RHCE tutorj]$ cd /home/user1
  [root@RHEL8-RHCE user1]$ touch file
  [root@RHEL8-RHCE user1]$ ll file
  -rw-r--r--. 1 root root 0 Jan 15 20:17 file
  
  # change ownership of file to user2
  [root@RHEL8-RHCE user1]$ chown user2 file
  [root@RHEL8-RHCE user1]$ ll file
  -rw-r--r--. 1 user2 root 0 Jan 15 20:17 file
  
  # change group of file to user1
  [root@RHEL8-RHCE user1]$ chgrp user1 file
  [root@RHEL8-RHCE user1]$ ll file
  -rw-r--r--. 1 user2 user1 0 Jan 15 20:17 file
  
  # merge
  [root@RHEL8-RHCE user1]$ chown user2:user1 file
  [root@RHEL8-RHCE user1]$ ll file
  -rw-r--r--. 1 user2 user1 0 Jan 15 20:17 file
  ```

- `chmod` - change file mode bits

  ```bash
  # syntax - user/group/others
  chmod u/g/o
  
  # = -> set 
  [root@RHEL8-RHCE user1]$ chmod u=rwx,g=rwx,o=rwx file
  [root@RHEL8-RHCE user1]$ ll file
  -rwxrwxrwx. 1 user2 user1 0 Jan 15 20:17 file
  
  # - -> remove
  [root@RHEL8-RHCE user1]$ chmod u-x,g-wx,o-rwx file
  [root@RHEL8-RHCE user1]$ ll file
  -rw-r-----. 1 user2 user1 0 Jan 15 20:17 file
  
  # + -> add
  [root@RHEL8-RHCE user1]$ ll file
  -rwxrw-r--. 1 user2 user1 0 Jan 15 20:17 file
  ```

- Demo#1

  ```bash
  # create dir
  [root@RHEL8-RHCE tmp]$ mkdir dir-test
  [root@RHEL8-RHCE tmp]$ ls -ld dir-test/
  drwxr-xr-x. 2 root root 6 Jan 15 20:33 dir-test/
  [root@RHEL8-RHCE tmp]$ touch dir-test/file
  
  # both user1 & user2 can access
  [user1@RHEL8-RHCE ~]$ cd /tmp/dir-test/                                             
  [user1@RHEL8-RHCE dir-test]$ ll                                                    
  total 0                                        
  -rw-r--r--. 1 root root 0 Jan 15 20:35 file
  [user2@RHEL8-RHCE ~]$ cd /tmp/dir-test/                                             
  [user2@RHEL8-RHCE dir-test]$ ll                                                    
  total 0                                        
  -rw-r--r--. 1 root root 0 Jan 15 20:35 file
  
  # remove x permission 
  [root@RHEL8-RHCE tmp]$ chmod o-x dir-test/
  [root@RHEL8-RHCE tmp]$ ll dir-test/
  total 0
  -rw-r--r--. 1 root root 0 Jan 15 20:35 file
  
  # user1 & user2 cannot access
  [user1@RHEL8-RHCE tmp]$ cd dir-test/                                                
  bash: cd: dir-test/: Permission denied 
  [user2@RHEL8-RHCE tmp]$ cd dir-test/                                                
  bash: cd: dir-test/: Permission denied 
  
  # change ownership
  [root@RHEL8-RHCE tmp]$ chown user1:user2 dir-test/
  [root@RHEL8-RHCE tmp]$ ls -ld dir-test/
  drwxr-xr--. 2 user1 user2 18 Jan 15 20:35 dir-test/
  
  # user1 is able to create
  [user1@RHEL8-RHCE tmp]$ cd dir-test/                                                
  [user1@RHEL8-RHCE dir-test]$ touch user1                                          
  [user1@RHEL8-RHCE dir-test]$ ll                                                     
  -rw-r--r--. 1 root  root  0 Jan 15 20:35 file                                       
  -rw-rw-r--. 1 user1 user1 0 Jan 15 20:43 user1
  
  # user2 is not allowed to create
  [user2@RHEL8-RHCE dir-test]$ touch user2
  [user1@RHEL8-RHCE dir-test]$ touch zk-test                                          
  touch: cannot touch 'user2': Permission denied
  
  # user1 can even delete file in root:root
  [user1@RHEL8-RHCE dir-test]$ ll                                                     
  total 0                                                                             
  -rw-r--r--. 1 root  root  0 Jan 15 20:35 file                                       
  -rw-rw-r--. 1 user1 user1 0 Jan 15 20:43 user1                                      
  [user1@RHEL8-RHCE dir-test]$ rm user1                                               
  [user1@RHEL8-RHCE dir-test]$ rm file                                                
  rm: remove write-protected regular empty file 'file'? y                             
  [user1@RHEL8-RHCE dir-test]$ ll                                                     
  total 0                                                                             
  [user1@RHEL8-RHCE dir-test]$ 
  ```

- Demo#2

  ```bash
  [root@RHEL8-RHCE dir-test]$ vim file
  [root@RHEL8-RHCE dir-test]$ ll
  total 4
  -rw-r--r--. 1 root user1 107 Jan 15 20:58 file
  
  # can't remove permission
  [user1@RHEL8-RHCE dir-test]$ chmod o-r file
  chmod: changing permissions of 'file': Operation not permitted
  
  # remove read from others
  [root@RHEL8-RHCE dir-test]$ chmod o-r file
  [root@RHEL8-RHCE dir-test]$ ll file
  -rw-r-----. 1 user1 root 107 Jan 15 20:58 file
  
  # change ownership to user1
  [root@RHEL8-RHCE dir-test]$ chown user1 file
  [root@RHEL8-RHCE dir-test]$ ll file
  -rw-r--r--. 1 user1 root 107 Jan 15 20:58 file
  
  # user1 can read
  [user1@RHEL8-RHCE dir-test]$ head -3 file
  sdfsdfsdfdfksdjfh sdfsdf
  sdf
  sdf
  
  # user2 can't read
  [user2@RHEL8-RHCE dir-test]$ cat file
  cat: file: Permission denied
  
  # +x for
  [user1@RHEL8-RHCE dir-test]$ touch test
  [user1@RHEL8-RHCE dir-test]$ ll
  total 4
  -rw-r--r--. 1 user1 root  107 Jan 15 20:58 file
  -rw-rw-r--. 1 user1 user1   0 Jan 15 21:10 test
  [user1@RHEL8-RHCE dir-test]$ chmod u+x test
  [user1@RHEL8-RHCE dir-test]$ ll test
  -rwxrw-r--. 1 user1 user1 0 Jan 15 21:10 test
  [user1@RHEL8-RHCE dir-test]$ cat > test << EOF
  > touch apple
  > touch orange
  > EOF
  [user1@RHEL8-RHCE dir-test]$ ./test
  [user1@RHEL8-RHCE dir-test]$ ll
  total 8
  -rw-rw-r--. 1 user1 user1   0 Jan 15 21:13 apple
  -rw-r--r--. 1 user1 root  107 Jan 15 20:58 file
  -rw-rw-r--. 1 user1 user1   0 Jan 15 21:13 orange
  -rwxrw-r--. 1 user1 user1  25 Jan 15 21:12 test
  
  ```

## 3. SUID/SGID/Sticky

- `SUID`   - SET UID - 應用於**可執行**的普通文件

  - 設置`SUID`，任何人一旦執行該文件，都會臨時獲得該文件擁有人的權限

    ```bash
    # 其他用戶仍可以通過passwd進行修改密碼
    [root@RHEL8-RHCE tutorj]$ ll /etc/shadow
    ----------. 1 root root 1550 Jan 15 20:16 /etc/shadow
    
    # rwx -> rws/rwS
    # 其他用戶執行該指令的時候都可以臨時獲得root用戶的執行權限進而修改/etc/shadow
    [root@RHEL8-RHCE tutorj]$ ll /bin/passwd
    -rwsr-xr-x. 1 root root 33424 Feb  8  2022 /bin/passwd
    
    # set/unset SUID
    chmod u+s file
    chmod u-s file
    ```

- `SGID`   - SET GID - 應用於目錄文件 - ==必考==

  - 儅設置`SGID`，任何用戶在該目錄下創建文件，文件的所屬組都會變成設置GID那個目錄的所屬組

    ```bash
    # set/unset SGID
    chmod g+s dir
    chmod g-s dir
    ```

- `Sticky` - 粘置位 - 應用於具有r權限的目錄文件

  - 儅設置`Sticky`，任何人在該目錄下創建的文件就只有自己和root可以刪除 = 限制了目錄的w權限

  - 如果不設置的話，只要用戶擁有該目錄的w權限，甚至連root創建的用戶都可以刪除

    ```bash
    # both user1 & user2 create a file under /tmp
    [user2@RHEL8-RHCE tmp]$ touch user2
    
    [user1@RHEL8-RHCE tmp]$ touch user1
    [user1@RHEL8-RHCE tmp]$ ll | grep touch
    [user1@RHEL8-RHCE tmp]$ ll | grep user
    drwxr-xr--. 2 user1  user2   30 Jan 15 21:13 dir-test
    -rw-rw-r--. 1 user1  user1    0 Jan 16 20:15 user1
    -rw-rw-r--. 1 user2  user2    0 Jan 16 20:15 user2
    
    # user1 cannot remove user2
    [user1@RHEL8-RHCE tmp]$ rm -rf user2
    rm: cannot remove 'user2': Operation not permitted
    
    # sticky bit on /tmp
    [user1@RHEL8-RHCE tmp]$ ls -ld /tmp
    drwxrwxrwt. 15 root root 4096 Jan 16 20:15 /tmp
    
    # set/unset Sticky
    chmod o+t dir
    chmod o-t dir
    ```

- 注意:exclamation:：儅設置特殊權限，x權限會被“覆蓋”
  - 如果小寫 - 有x
  - 如果大寫 - 無x

## 4. umask

- 創建目錄文件的default權限 - 777 - rwxrwxrwx

- 創建普通文件的default權限 - 666 - rw-rw-rw-

- umask - 能夠幫助用戶修改創建文件的默認權限

  - 用戶創建目錄文件 - 0777 - umask
  - 用戶創建普通文件 - 0666 - umask

  ```bash
  # root umask
  [root@RHEL8-RHCE tutorj]$ umask
  0022
  # create dir
  # 777 - 022 = 755 - rwxr-xr-x
  [root@RHEL8-RHCE tutorj]$ mkdir dir
  [root@RHEL8-RHCE tutorj]$ ll -d dir
  drwxr-xr-x. 2 root root 6 Jan 16 20:36 dir
  # create file
  # 666 - 022 = 644 - rw-r--r-- 
  [root@RHEL8-RHCE tutorj]$ touch file
  [root@RHEL8-RHCE tutorj]$ ll file
  -rw-r--r--. 1 root root 0 Jan 16 20:36 file
  
  # normal user umask
  [user2@RHEL8-RHCE tmp]$ umask
  0002
  # create dir
  # 777 - 002 = 775 - rwxrwxr-x
  [user2@RHEL8-RHCE tmp]$ mkdir dir
  [user2@RHEL8-RHCE tmp]$ ll -d dir
  drwxrwxr-x. 2 user2 user2 6 Jan 16 20:37 dir
  
  # 666 - 002 = 664 - rw-rw-r--
  [user2@RHEL8-RHCE tmp]$ touch file
  [user2@RHEL8-RHCE tmp]$ ll file
  -rw-rw-r--. 1 user2 user2 0 Jan 16 20:37 file
  
  # change umask temporarily - works only in current shell
  umask xxxx
  
  # change permanently for normal users
  [root@RHEL8-RHCE tutorj]$ vim /etc/bashrc
  
      # By default, we want umask to get set. This sets it for non-login shell.
      # Current threshold for system reserved uid/gids is 200
      # You could check uidgid reservation validity in
      # /usr/share/doc/setup-*/uidgid file
      if [ $UID -gt 199 ] && [ "`/usr/bin/id -gn`" = "`/usr/bin/id -un`" ]; then
         umask 002
      else
         umask 022
      fi
  
  # safer 
  [user2@RHEL8-RHCE ~]$ vim .bashrc
  [user2@RHEL8-RHCE ~]$ cat .bashrc
  # .bashrc
  umask xxxx
  [user2@RHEL8-RHCE ~]$ source .bashrc
  ```

## 5. ACL

- 需求

  ```bash
  # 1
  - 對一個普通文件file進行權限設置，其中有3個用戶：user1, user2, user3，要求：
    1. user1對file具有rwx
    2. user2對file具有rw
    3. user3對file具有r
  - Solution: user1為file的擁有者（rwx）+ user2為file的group（rx）+user3為file的other（r）
    
    
  #2
  - 對一個普通文件file進行權限設置，其中有4個用戶：user1, user2, user3，user4，要求：
    1. user1對file具有rwx
    2. user2對file具有rw
    3. user3對file具有r
    4. user4對file無任何權限   # 對於超出3類人以上的權限，文件表面的權限已經無法實現
  - Solution: ???            # 使用ACL解決
  ```

  

- ==普通文件ACL== - 允許某個用戶/用戶組對文件設置特別的權限

  - 一旦設置了acl，則該文件的權限最後會變成`+`，此時該文件表面上看到的權限全都不一定生效
  - **自上而下匹配，匹配后就停止匹配**，即便後面有更高的權限，如果前面匹配到，也會停留在匹配的位置

  ```bash
  #  set file acl
  [tutorj@RHEL8-RHCE ~]$ sudo setfacl -m u:user1:rwx authorized_keys
  # + at tail
  [tutorj@RHEL8-RHCE ~]$ ll authorized_keys
  -rw-rwx---+ 1 tutorj tutorj 393 Jan  3 20:04 authorized_keys
  
  # check file acl
  [tutorj@RHEL8-RHCE ~]$ getfacl authorized_keys
  # file: authorized_keys  # 文件名
  # owner: tutorj          # 文件擁有者
  # group: tutorj          # 文件所屬組
  user::rw-                # 文件擁有者權限
  user:user1:rwx           # acl for user1 - rwx to this file
  group::---               # 文件所屬組權限
  mask::rwx                # 
  other::---               # others權限
  
  # remove file acl
  [tutorj@RHEL8-RHCE ~]$ setfacl -x u:user1 authorized_keys
  [tutorj@RHEL8-RHCE ~]$ getfacl authorized_keys
  # file: authorized_keys
  # owner: tutorj
  # group: tutorj
  user::rw-
  group::---
  mask::---
  other::---
  
  # + still remains
  [tutorj@RHEL8-RHCE ~]$ ll authorized_keys
  -rw-------+ 1 tutorj tutorj 393 Jan  3 20:04 authorized_keys
  
  # remove all extended acl entries
  [tutorj@RHEL8-RHCE ~]$ setfacl -b authorized_keys
  [tutorj@RHEL8-RHCE ~]$ ll authorized_keys
  -rw-------. 1 tutorj tutorj 393 Jan  3 20:04 authorized_keys
  
  [tutorj@RHEL8-RHCE ~]$ getfacl authorized_keys
  # file: authorized_keys
  # owner: tutorj
  # group: tutorj
  user::rw-
  group::---
  other::---
  ```

  

- ==目錄文件ACL== - 針對目錄設置意義不大
  
  - 目錄的權限只有3種有意義：---/r-x/rwx，剛好對應3類人
  
  - 不在於訪問控制，我們希望儅一個新的文件被創建的時候，讓文件繼承default權限
  
  ```bash
  [root@RHEL8-RHCE tutorj]$ mkdir test
  [root@RHEL8-RHCE tutorj]$ ll -d test
  drwxr-xr-x. 2 root root 6 Jan 17 19:47 test
  
  # set acl
  [root@RHEL8-RHCE tutorj]$ setfacl -m d:u:user1:r test/
  # + at tail
  [root@RHEL8-RHCE tutorj]$ ll -d test
  drwxr-xr-x+ 2 root root 6 Jan 17 19:47 test
  
  # get acl
  [root@RHEL8-RHCE tutorj]$ getfacl test/
  # file: test/
  # owner: root
  # group: root
  user::rwx
  group::r-x
  other::r-x
  # ++ default，表示在該目錄下創建的文件具有的默認權限
  default:user::rwx
  default:user:user1:r--  # 其中user1創建的只有r
  default:group::r-x
  default:mask::r-x       # 表示該文件的最大權限，創建文件的acl不能超過該權限
  default:other::r-x
  
  # create a file under 
  [root@RHEL8-RHCE tutorj]$ touch test/file
  [root@RHEL8-RHCE tutorj]$ getfacl test/file
  # file: test/file
  # owner: root
  # group: root
  user::rw-
  user:user1:r--
  group::r-x                      #effective:r--
  mask::r--
  other::r--
  
  # modify mask
  [root@RHEL8-RHCE tutorj]$ setfacl -m mask:r-x test/file
  [root@RHEL8-RHCE tutorj]$ getfacl test/file
  # file: test/file
  # owner: root
  # group: root
  user::rw-
  user:user1:r--
  group::r-x
  mask::r-x
  other::r--
  ```
  
  ```bash
  # 針對目錄設置acl權限，要求之後在該目錄創建的文件，具有以下acl權限
  # 文件擁有者rwx
  # 文件所屬組rw
  # 其他人r
  # user1無任何權限
  [root@RHEL8-RHCE tutorj]$ setfacl -m d:user::rwx test/
  [root@RHEL8-RHCE tutorj]$ setfacl -m d:group::rw test/
  [root@RHEL8-RHCE tutorj]$ setfacl -m d:other::r test/
  [root@RHEL8-RHCE tutorj]$ setfacl -m d:user:user1:--- test/
  
  [root@RHEL8-RHCE tutorj]$ getfacl test/
  # file: test/
  # owner: root
  # group: root
  user::rwx
  group::r-x
  other::r-x
  default:user::rwx
  default:user:user1:---
  default:group::rw-
  default:mask::rw-
  default:other::r--
  
  [root@RHEL8-RHCE tutorj]$ touch test/file
  [root@RHEL8-RHCE tutorj]$ getfacl test/file
  # file: test/file
  # owner: root
  # group: root
  user::rw-
  user:user1:---
  group::rw-
  mask::rw-         # mask limit user to be rw-
  other::r--
  
  ```

## 6. sudoers

- `/etc/sudoers` - 讓普通用戶獲得管理員權限的一種方式（狐假虎威）

  ```bash
  [user1@RHEL8-RHCE ~]$ useradd user4
  useradd: Permission denied.
  useradd: cannot lock /etc/passwd; try again later.
  [user1@RHEL8-RHCE ~]$ ll /usr/sbin/useradd
  -rwxr-xr-x. 1 root root 151792 Jul 21 22:36 /usr/sbin/useradd
  
  ## Sudoers allows particular users to run various commands as
  ## the root user, without needing the root password.
  [root@RHEL8-RHCE tutorj]$ vim /etc/sudoers
  ## Next comes the main part: which users can run what software on
  ## which machines (the sudoers file can be shared between multiple
  ## systems).
  ## Syntax:
  ##
  ##      user    MACHINE=COMMANDS
  ##
  ## The COMMANDS section may have other options added to it.
  ##
  ## Allow root to run any commands anywhere
  root    ALL=(ALL)       ALL
  user1   ALL=(ALL)       ALL    # add user1 
  
  ## Allows members of the 'sys' group to run networking, software,
  ## service management apps and more.
  # %sys ALL = NETWORKING, SOFTWARE, SERVICES, STORAGE, DELEGATING, PROCESSES, LOCATE, DRIVERS
  
  ## Allows people in group wheel to run all commands
  %wheel  ALL=(ALL)       ALL
  %tempgroup  ALL=(ALL)       ALL		# all users in tempgroup can run all cmd at anywhere but need password
  
  ## Allows members of the users group to mount and unmount the
  ## cdrom as root
  # %users  ALL=/sbin/mount /mnt/cdrom, /sbin/umount /mnt/cdrom
  user2	ALL=/sbin/useradd	# user2 can only run /sbin/useradd
  
  ## Same thing without a password
  # %wheel        ALL=(ALL)       NOPASSWD: ALL
  %tempgroup        ALL=(ALL)       NOPASSWD: ALL		# all users in tempgroup can run all cmd at anywhere no need password
  
  # set pwd for user1
  [root@RHEL8-RHCE tutorj]$ echo rootroot | passwd --stdin user1
  Changing password for user user1.
  passwd: all authentication tokens updated successfully.
  
  # create successfully
  [user1@RHEL8-RHCE ~]$ sudo useradd user4
  [sudo] password for user1:
  [user1@RHEL8-RHCE ~]$ grep user4 /etc/passwd
  user4:x:1004:1004::/home/user4:/bin/bash
  
  
  # 为了频繁的执行某些只有超级用户才能执行的权限，而不用每次输入密码，可以使用该命令
  # 提示输入密码时该密码为当前账户的密码。没有时间限制
  [tutorj@RHEL8-RHCE ~]$ sudo -i
  [sudo] password for tutorj:
  [root@RHEL8-RHCE ~]$ pwd
  /root
  ```

## 7. Extra

### 7.1 +openssl手動設置用戶密碼

### 7.2 sudoers

### 7.3 文件高級屬性

### 7.4 skel

### 7.5 Linux通用4道權限

